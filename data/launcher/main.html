<!DOCTYPE html>
<html lang="en" style="background:#0a0a0a;">
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <title>BOIII</title>
    <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    .nav-sidebar, .nav-btn, .btn, .settings-btn, .settings-dropdown, .option-btn,
    .popup-backdrop, .popup-header, .popup-close, .page, .mod-card,
    .progress-footer, .version { -ms-user-select: none; -webkit-user-select: none; user-select: none; }

    input[type="text"], textarea {
      -ms-user-select: text !important;
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      user-select: text !important;
      cursor: text !important;
      -webkit-touch-callout: default;
    }

    #playerName, #workshopId {
      -ms-user-select: text !important;
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      user-select: text !important;
      cursor: text !important;
    }

      html, body {
      font-family: "Segoe UI", Tahoma, Arial, sans-serif;
      height: 100%; min-height: 100vh; display: flex; flex-direction: column;
      overflow: hidden; cursor: default;
      background-color: #0a0a0a;
      background-image: url('bigboiii.jpg');
      background-position: 50% 50%;
      background-size: cover;
      background-repeat: no-repeat;
      opacity: 0;
      animation: fadeIn 0.6s ease-in forwards;
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    .main-container {
      display: flex; flex: 1; overflow: hidden; position: relative; z-index: 1;
    }
    .main-container::before {
      content: "";
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(180deg, rgba(0,0,0,0.4) 0%, rgba(0,0,0,0.7) 100%);
      pointer-events: none;
      z-index: 0;
    }

    .nav-sidebar {
      width: 80px;
      background: rgba(42,42,42,0.95);
      border-right: 1px solid rgba(68,65,63,0.6);
        display: flex;
        flex-direction: column;
      padding: 20px 0;
      z-index: 50;
      box-shadow: 4px 0 12px rgba(0,0,0,0.5);
    }

    .nav-btn {
      padding: 20px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      cursor: pointer;
      border: none;
        background: transparent;
      color: rgba(200,196,192,0.7);
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      transition: all 0.2s;
      border-left: 3px solid transparent;
    }

    .nav-btn:hover {
      background: rgba(255,255,255,0.05);
      color: rgba(249,115,22,0.9);
    }

    .nav-btn.active {
      background: rgba(249,115,22,0.1);
      color: rgba(249,115,22,0.95);
      border-left-color: rgba(249,115,22,0.8);
    }

    .nav-icon {
      font-size: 1.5rem;
      margin-bottom: 8px;
    }

    .content-area {
      flex: 1; display: flex; flex-direction: column;
      padding: 30px 40px 50px 50px;
      overflow-y: auto;
      position: relative;
      z-index: 1;
      background: transparent;
    }
    .content-area .page { position: relative; z-index: 1; }

    .page {
      display: none;
    }

    .page.active {
      display: block;
    }

    #workshopPage.active {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }

    #mainPage.active {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      min-height: 0;
    }

    h1 {
      font-size: 4rem; font-weight: 700; margin: 0;
      letter-spacing: 0.04em;
      text-shadow: 0 0 24px rgba(249,115,22,0.5), 0 4px 12px rgba(0,0,0,0.8);
    }
    h1 .big-e { font-size: 1.2em; }
    h1 .orange { color: #f97316; }
    h1 .white { color: #fff; }

    h2 {
      font-size: 2rem;
      color: #fff;
      margin-bottom: 20px;
      text-shadow: 0 2px 8px rgba(0,0,0,0.8);
    }

    .description {
      text-align: center; color: rgba(244,240,235,0.65);
      font-size: 0.88rem; line-height: 1.6; margin-bottom: 0;
      max-width: 480px;
    }

    .main-content  {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      max-width: 440px;
    }

    .main-content > * + * {
      margin-top: 24px;
    }

    .main-left {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
      align-items: center;
    }

    .main-right {
      display: flex;
      flex-direction: column;
      gap: 16px;
      width: 100%;
      align-items: center;
    }

    .play-section {
      display: flex;
      flex-direction: column;
      width: 100%;
      align-items: center;
    }

    .btn-play-large {
      display: inline-flex; 
      align-items: center; 
      justify-content: center;
      border: 1px solid rgba(249,115,22,0.6);
      color: #fff;
      cursor: pointer;
      background: linear-gradient(145deg, rgba(249,115,22,0.35), rgba(220,38,38,0.25));
      padding: 18px 60px;
      border-radius: 8px;
      font-size: 1.2rem; 
      font-weight: 700; 
      font-family: inherit;
      transition: all 0.25s ease;
      box-shadow: 0 4px 12px rgba(249,115,22,0.3);
      position: relative;
      overflow: hidden;
      letter-spacing: 0.04em;
      width: 100%;
    }

    .btn-play-large::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
      transition: left 0.5s;
      pointer-events: none;
    }

    .btn-play-large:hover::before {
      left: 100%;
    }

    .btn-play-large:hover {
      background: linear-gradient(145deg, rgba(249,115,22,0.5), rgba(220,38,38,0.35));
      border-color: rgba(249,115,22,0.8);
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(249,115,22,0.4);
    }

    .btn-play-large:active {
      transform: translateY(0);
    }

    .btn-play-large:disabled { 
      opacity: 0.6; 
      cursor: not-allowed; 
      transform: none; 
    }

    .action-buttons {
      display: flex;
      width: 100%;
      flex-wrap: wrap;
      justify-content: center;
    }

    .action-buttons .btn {
      width: 120px;
      min-width: 0;
      max-width: none;
      padding: 10px 8px;
      font-size: 0.82rem;
      margin: 0 5px;
    }

    .btn {
      display: inline-flex; align-items: center; justify-content: center;
      border: 1px solid rgba(68,65,63,0.6);
      color: rgba(244,240,235,0.92);
      cursor: pointer;
      background: linear-gradient(145deg, rgba(48,45,44,0.85), rgba(38,36,35,0.85));
      padding: 12px 18px;
      border-radius: 6px;
      font-size: 0.9rem; font-weight: 500; font-family: inherit;
      transition: all 0.25s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      position: relative;
      overflow: hidden;
    }

    .btn::before {
      content: "";
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
      transition: left 0.5s;
      pointer-events: none;
    }

    .btn:hover::before {
      left: 100%;
    }

    .btn:hover {
      background: linear-gradient(145deg, rgba(58,55,54,0.9), rgba(48,45,44,0.9));
      border-color: rgba(74,71,69,0.8);
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.4);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn.primary {
      background: linear-gradient(145deg, rgba(249,115,22,0.25), rgba(220,38,38,0.2));
      border-color: rgba(249,115,22,0.6);
      color: #fff;
      font-size: 0.95rem;
      padding: 12px 24px;
      font-weight: 600;
    }

    .btn.primary:hover {
      background: linear-gradient(145deg, rgba(249,115,22,0.35), rgba(220,38,38,0.3));
      border-color: rgba(249,115,22,0.8);
      box-shadow: 0 6px 12px rgba(249,115,22,0.3);
    }

    .btn.danger {
      background: linear-gradient(145deg, rgba(220,38,38,0.25), rgba(185,28,28,0.2));
      border-color: rgba(220,38,38,0.6);
      color: #fff;
      font-weight: 600;
    }
    .btn.danger:hover {
      background: linear-gradient(145deg, rgba(220,38,38,0.4), rgba(185,28,28,0.35));
      border-color: rgba(220,38,38,0.8);
      box-shadow: 0 6px 12px rgba(220,38,38,0.3);
    }

    .btn.discord {
      background: linear-gradient(145deg, rgba(88,101,242,0.25), rgba(67,81,232,0.2));
      border-color: rgba(88,101,242,0.5);
    }

    .btn.discord:hover {
      background: linear-gradient(145deg, rgba(88,101,242,0.35), rgba(67,81,232,0.3));
      border-color: rgba(88,101,242,0.7);
      box-shadow: 0 6px 12px rgba(88,101,242,0.3), 0 0 20px rgba(88,101,242,0.2);
    }

    .btn.forum {
      background: linear-gradient(145deg, rgba(139,92,246,0.25), rgba(124,58,237,0.2));
      border-color: rgba(139,92,246,0.5);
    }

    .btn.forum:hover {
      background: linear-gradient(145deg, rgba(139,92,246,0.35), rgba(124,58,237,0.3));
      border-color: rgba(139,92,246,0.7);
      box-shadow: 0 6px 12px rgba(139,92,246,0.3), 0 0 20px rgba(139,92,246,0.2);
    }

    .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    .player-section {
      width: 100%;
    }

    .player-label {
      font-size: 0.68rem; font-weight: 600; letter-spacing: 0.15em;
      text-transform: uppercase; color: rgba(249,115,22,0.6);
      margin-bottom: 8px;
      text-align: center;
    }

    .input-wrap {
      position: relative;
      width: 100%;
    }

    .input-wrap::before,
    .input-wrap::after {
      content: "";
      position: absolute;
      width: 9px;
      height: 9px;
      border-color: rgba(249, 115, 22, 0.4);
      border-style: solid;
      pointer-events: none;
      z-index: 1;
    }
    .input-wrap::before {
      top: -1px; left: -1px;
      border-width: 1.5px 0 0 1.5px;
      border-radius: 3px 0 0 0;
    }
    .input-wrap::after {
      top: -1px; right: -1px;
      border-width: 1.5px 1.5px 0 0;
      border-radius: 0 3px 0 0;
    }
    .corner-bl, .corner-br {
      position: absolute;
      width: 9px;
      height: 9px;
      border-color: rgba(249, 115, 22, 0.4);
      border-style: solid;
      pointer-events: none;
      z-index: 1;
    }
    .corner-bl {
      bottom: -1px; left: -1px;
      border-width: 0 0 1.5px 1.5px;
      border-radius: 0 0 0 3px;
    }
    .corner-br {
      bottom: -1px; right: -1px;
      border-width: 0 1.5px 1.5px 0;
      border-radius: 0 0 3px 0;
    }

    .player-input {
        width: 100%;
      background: linear-gradient(145deg, rgba(30,28,27,0.85), rgba(22,21,20,0.85));
      border: 1px solid rgba(249,115,22,0.28);
      border-radius: 8px;
      color: rgba(244,240,235,0.92);
      font-size: 0.9rem; padding: 10px 16px;
      text-align: center; outline: none;
      transition: all 0.25s;
      box-shadow: 0 2px 6px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);
      font-weight: 500;
      letter-spacing: 0.06em;
      cursor: text !important;
      -ms-user-select: text !important;
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      user-select: text !important;
    }

    .player-input::placeholder {
      color: rgba(200,195,190,0.32);
      font-weight: 400;
    }

    .player-input:focus {
      border-color: rgba(249,115,22,0.55);
      box-shadow: 0 0 10px rgba(249,115,22,0.22), 0 2px 6px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.06);
    }

    .progress-footer {
      position: fixed; bottom: 0; left: 0; right: 0;
      background: rgba(42,42,42,0.95);
      border-top: 1px solid rgba(249,115,22,0.4);
      padding: 12px 20px;
      display: none; align-items: center;
      z-index: 100;
    }

    .progress-footer > * { margin-left: 16px; }
    .progress-footer > *:first-child { margin-left: 0; }

    .progress-footer.active { display: flex; }

    .progress-info {
      flex: 1; font-size: 0.85rem; color: rgba(244,240,235,0.9);
    }

    .progress-bar-container {
      width: 300px; height: 8px;
      background: rgba(68,65,63,0.5);
      border-radius: 4px; overflow: hidden;
    }

    .progress-fill {
      height: 100%; background: rgba(249,115,22,0.8);
      width: 0%; transition: width 0.3s;
    }
    .progress-fill.indeterminate {
      width: 30% !important;
      animation: progress-marquee 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }
    @keyframes progress-marquee {
      0%   { transform: translateX(-100%); }
      100% { transform: translateX(433%);  }
    }

    .progress-percent {
      font-size: 0.85rem; color: rgba(249,115,22,0.9);
      font-weight: 600; min-width: 50px; text-align: right;
    }

    .progress-cancel {
      width: 28px; height: 28px;
      background: rgba(68,65,63,0.6);
      border: none; border-radius: 4px;
      color: rgba(244,240,235,0.8);
      cursor: pointer; font-size: 18px;
      transition: background 0.2s;
    }

    .progress-cancel:hover { background: rgba(220,38,38,0.6); }
  
    .progress-folder {
      width: 28px; height: 28px;
      background: rgba(68,65,63,0.6);
      border: none; border-radius: 4px;
      color: rgba(244,240,235,0.8);
      cursor: pointer; font-size: 15px;
      transition: background 0.2s;
      display: flex; align-items: center; justify-content: center;
    }
    .progress-folder:hover { background: rgba(249,115,22,0.6); }

    .version {
      position: fixed; bottom: 10px; right: 14px;
      font-size: 0.72rem; color: rgba(200,196,192,0.5);
      font-family: Consolas, monospace; z-index: 10;
    }

    .settings-btn {
      position: fixed; top: 20px; right: 20px; z-index: 60;
      width: 40px; height: 40px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      border: 1px solid rgba(68,65,63,0.5);
      border-radius: 8px;
      background: linear-gradient(145deg, rgba(42,40,39,0.9), rgba(32,30,29,0.9));
      transition: all 0.3s ease;
    }

    .settings-btn:hover {
      border-color: rgba(249,115,22,0.5);
      background: linear-gradient(145deg, rgba(52,49,48,0.95), rgba(42,40,39,0.95));
    }

    .settings-btn svg {
      width: 20px; height: 20px; fill: rgba(200,196,192,0.75);
      transition: all 0.3s ease;
    }

    .settings-btn:hover svg {
      fill: rgba(249,115,22,0.85);
      transform: rotate(45deg);
    }

    .settings-dropdown {
      position: fixed; top: 70px; right: 20px; z-index: 59;
      display: flex; flex-direction: column;
      opacity: 0; pointer-events: none; transform: translateY(-6px);
      transition: opacity 0.18s, transform 0.18s;
      background: rgba(42,42,42,0.95);
      padding: 14px;
      border-radius: 8px;
      border: 1px solid rgba(68,65,63,0.6);
      box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    }

    .settings-dropdown.open { opacity: 1; pointer-events: auto; transform: translateY(0); }

    .settings-dropdown h4 {
      font-size: 0.7rem;
      color: rgba(249,115,22,0.8);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      margin-bottom: 8px;
      padding-left: 4px;
    }

    .option-btn {
      display: flex; align-items: center;
      padding: 6px 12px; border-radius: 6px;
      border: 1px solid rgba(68,65,63,0.45);
      background: linear-gradient(145deg, rgba(38,36,35,0.9), rgba(28,27,26,0.9));
      cursor: pointer; font-size: 0.85rem;
      color: rgba(200,196,192,0.85);
      transition: all 0.2s;
      margin-top: 6px;
    }
    .option-btn:first-of-type { margin-top: 0; }

    .option-btn:last-child { margin-bottom: 0; }

    .option-btn:hover {
      background: linear-gradient(145deg, rgba(48,46,45,0.95), rgba(38,36,35,0.95));
      border-color: rgba(74,71,69,0.6);
    }

    .option-btn.active {
      border-color: rgba(249,115,22,0.6);
      background: linear-gradient(145deg, rgba(249,115,22,0.2), rgba(180,40,10,0.15));
      color: rgba(240,230,220,0.95);
    }

    .option-btn .dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: rgba(100,97,95,0.5);
      transition: background 0.2s;
      flex-shrink: 0;
      margin-right: 12px;
    }

    .option-btn.active .dot { background: rgba(249,115,22,0.9); }

    .popup-backdrop {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000;
      background: rgba(0,0,0,0.7);
      display: none; align-items: center; justify-content: center;
    }

    .popup-backdrop.active { display: flex; align-items: center; justify-content: center; }

    .popup {
      background: rgba(42,42,42,0.98);
      border: 1px solid rgba(249,115,22,0.4);
      border-radius: 8px;
      width: 500px; max-width: 90vw;
      max-height: 85vh; overflow-y: auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    .popup-header {
      padding: 20px; border-bottom: 1px solid rgba(68,65,63,0.5);
      display: flex; justify-content: space-between; align-items: center;
    }

    .popup-header h3 {
      margin: 0; color: #fff; font-size: 1.1rem; font-weight: 600;
    }

    .popup-close {
      background: none; border: none;
      color: rgba(200,196,192,0.8);
      font-size: 24px; cursor: pointer;
      width: 30px; height: 30px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .popup-close:hover { background: rgba(255,255,255,0.1); }

    .popup-content {
      padding: 20px;
      color: rgba(244, 240, 235, 0.92);
    }

    .component-selection-popup .popup-content { padding: 25px; }
    .component-selection-popup .component-selection-section { margin-bottom: 20px; }
    .component-selection-popup .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .component-selection-popup .section-header label { color: rgba(200,196,192,0.9); font-size: 14px; font-weight: 500; }
    .component-selection-popup .components-list {
      background: rgba(0,0,0,0.4); border: 1px solid rgba(68,65,63,0.5);
      border-radius: 6px; padding: 10px; margin-bottom: 20px;
    }
    .component-selection-popup .component-item {
      display: flex; align-items: center;
      padding: 10px 12px; margin-bottom: 8px;
      background: rgba(42,42,42,0.8);
      border: 2px solid transparent;
      border-radius: 4px;
        cursor: pointer;
      transition: all 0.2s;
    }
    .component-selection-popup .component-item:last-child { margin-bottom: 0; }
    .component-selection-popup .component-item:hover { background: rgba(52,50,48,0.9); }
    .component-selection-popup .component-checkbox {
      display: flex; align-items: center; margin-right: 12px; position: relative;
    }
    .component-selection-popup .component-checkbox input[type="checkbox"] {
      width: 18px; height: 18px; margin: 0; cursor: pointer;
      position: absolute; left: 0; top: 50%; transform: translateY(-50%); opacity: 0; z-index: 2;
    }
    .component-selection-popup .component-checkbox .checkbox-visual {
      width: 18px; height: 18px; min-width: 18px;
      border: 2px solid rgba(100,97,95,0.8);
      border-radius: 4px;
      cursor: pointer;
      margin-right: 12px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
      background: transparent;
    }
    .component-selection-popup .component-checkbox input[type="checkbox"]:checked + .checkbox-visual {
      background: rgba(249,115,22,0.9);
      border-color: rgba(249,115,22,0.9);
    }
    .component-selection-popup .component-checkbox input[type="checkbox"]:checked + .checkbox-visual::after {
      content: "âœ“"; color: #fff; font-size: 12px; font-weight: bold;
    }
    .component-selection-popup .component-info { flex: 1; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .component-selection-popup .component-name { font-size: 14px; color: #fff; font-weight: 500; }
    .component-selection-popup .component-size { font-size: 13px; color: rgba(249,115,22,0.9); }
    .component-selection-popup .install-download-info-section { margin-bottom: 20px; }
    .component-selection-popup .install-download-info-section label { display: block; color: rgba(200,196,192,0.8); font-size: 14px; margin-bottom: 8px; }
    .component-selection-popup .install-info-row { margin-bottom: 4px; }
    .component-selection-popup .install-info-label { color: rgba(200,196,192,0.7); margin-right: 8px; }
    .component-selection-popup .install-info-value { color: #fff; font-weight: 500; }

    .popup-actions {
      display: flex; justify-content: flex-end;
      padding: 20px; border-top: 1px solid rgba(68,65,63,0.5);
    }
    .popup-actions .btn { margin-left: 8px; }
    .popup-actions .btn:first-child { margin-left: 0; }

    .verify-popup .popup-content { padding: 20px; }
    .verify-group-label {
      display: block; font-size: 0.8rem; color: rgba(200,196,192,0.8);
      text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 10px;
    }
    .verify-mode-list { display: flex; gap: 8px; margin-bottom: 18px; }
    .verify-mode-btn {
      flex: 1; padding: 10px 6px; border: 1px solid rgba(68,65,63,0.6);
      border-radius: 6px; background: rgba(30,28,27,0.8); color: rgba(200,196,192,0.8);
      font-size: 0.82rem; font-weight: 500; cursor: pointer; text-align: center;
      transition: all 0.2s; font-family: inherit;
    }
    .verify-mode-btn:hover { border-color: rgba(249,115,22,0.5); color: #fff; }
    .verify-mode-btn.selected {
      background: rgba(249,115,22,0.2); border-color: rgba(249,115,22,0.7);
      color: #fff;
    }
    .verify-progress-section { display: none; margin-bottom: 16px; }
    .verify-progress-section.active { display: block; }
    .verify-status-msg {
      font-size: 0.88rem; color: rgba(249,115,22,0.9); font-weight: 600; margin-bottom: 8px;
    }
    .verify-progress-bar {
      position: relative; height: 22px; background: rgba(68,65,63,0.5);
      border-radius: 4px; overflow: hidden; margin-bottom: 6px;
    }
    .verify-progress-fill {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, rgba(249,115,22,0.7), rgba(249,115,22,0.95));
      transition: width 0.3s; border-radius: 4px;
    }
    .verify-progress-pct {
      position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
      font-size: 0.75rem; color: #fff; font-weight: 600; text-shadow: 0 1px 3px rgba(0,0,0,0.8);
    }
    .verify-status-details {
      font-size: 0.78rem; color: rgba(200,196,192,0.65);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .verify-actions { display: flex; justify-content: flex-end; gap: 8px; }
    .verify-results { display: none; margin-bottom: 14px; }
    .verify-results.active { display: block; }
    .verify-results-ok {
      padding: 14px; text-align: center; color: rgba(34,197,94,0.95);
      font-size: 0.92rem; font-weight: 600;
      background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.25);
      border-radius: 6px;
    }
    .verify-results-bad {
      max-height: 180px; overflow-y: auto;
      background: rgba(0,0,0,0.35); border: 1px solid rgba(239,68,68,0.3);
      border-radius: 6px; padding: 8px;
    }
    .verify-results-bad .verify-file-item {
      padding: 5px 8px; font-size: 0.78rem; color: rgba(239,68,68,0.9);
      border-bottom: 1px solid rgba(68,65,63,0.3); word-break: break-all;
    }
    .verify-results-bad .verify-file-item:last-child { border-bottom: none; }

    .workshop-input-row {
      display: flex; margin-bottom: 20px;
      max-width: 600px;
    }
    .workshop-input-row > * { margin-right: 12px; }
    .workshop-input-row > *:last-child { margin-right: 0; }

    .workshop-input-row input {
      flex: 1;
      background: rgba(30,28,27,0.9);
      border: 1px solid rgba(249,115,22,0.3);
      border-radius: 8px;
      color: #fff; padding: 12px 16px;
      font-size: 0.95rem; outline: none;
      cursor: text !important;
      -ms-user-select: text !important;
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      user-select: text !important;
    }

    .workshop-input-row input::placeholder { color: rgba(200,196,192,0.4); }
    .workshop-input-row input:focus { border-color: rgba(249,115,22,0.6); }

    .workshop-progress {
      margin-bottom: 20px;
      max-width: 600px;
    }

    .workshop-progress-bar {
      width: 100%;
      margin-bottom: 8px;
    }

    .workshop-progress-fill {
      height: 100%; background: linear-gradient(90deg, rgba(249,115,22,0.7), rgba(249,115,22,0.9));
      width: 0%; transition: width 0.3s;
      border-radius: 4px;
    }
    .workshop-progress-fill.indeterminate {
      width: 30% !important;
      animation: ws-marquee 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }
    @keyframes ws-marquee {
      0%   { transform: translateX(-100%); }
      100% { transform: translateX(433%);  }
    }

    .workshop-status {
      font-size: 0.85rem; color: rgba(200,196,192,0.9);
      min-height: 1em;
    }

    .mods-grid-wrap {
      max-height: 520px;
      overflow-y: auto;
      overflow-x: hidden;
      margin-top: 12px;
      border: 1px solid rgba(68,65,63,0.4);
      border-radius: 8px;
      background: rgba(0,0,0,0.25);
    }
    .mods-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 14px;
      padding: 14px;
    }

    .mods-pagination {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      padding: 10px 4px 4px 4px;
      gap: 8px;
      font-size: 0.78rem;
      color: rgba(200,196,192,0.7);
    }

    .mods-pagination .btn {
      padding: 4px 10px;
      font-size: 0.75rem;
      min-width: 50px;
      border-radius: 4px;
      line-height: 1.2;
    }

    .mod-card {
      display: flex;
      align-items: flex-start;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(68,65,63,0.5);
      border-radius: 8px;
      padding: 16px;
      transition: all 0.2s;
      cursor: pointer;
    }

    .mod-card:hover {
      background: rgba(0,0,0,0.6);
      border-color: rgba(249,115,22,0.4);
      transform: translateY(-2px);
    }

    .mod-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 8px;
    }

    .mod-card-name {
      font-size: 1rem;
      color: rgba(244,240,235,0.95);
        font-weight: 500;
      flex: 1;
      word-wrap: break-word;
    }

    .mod-card-type {
      font-size: 0.75rem;
      color: rgba(249,115,22,0.8);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      background: rgba(249,115,22,0.15);
      padding: 4px 8px;
      border-radius: 4px;
      margin-left: 8px;
      white-space: nowrap;
    }

    .mod-card-body {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-width: 0;
      margin-left: 14px;
    }
    .mod-card-description {
      font-size: 0.78rem;
      color: rgba(200,196,192,0.55);
      line-height: 1.3;
      margin-top: 4px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      word-break: break-word;
    }
    .mod-card-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 14px;
      margin-top: 6px;
      font-size: 0.72rem;
      color: rgba(200,196,192,0.45);
    }
    .mod-card-meta span {
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }
    .mod-card-meta .meta-icon {
      font-size: 0.8rem;
      opacity: 0.7;
    }
    .mod-card-actions {
      display: flex;
      margin-top: 12px;
      flex-wrap: wrap;
    }
    .mod-card-actions .btn {
      padding: 8px 16px;
      font-size: 0.85rem;
      min-width: auto;
      margin-right: 6px;
    }
    .mod-card-actions .btn:last-child { margin-right: 0; }
    .mod-card-image-wrap {
      width: 80px;
      height: 80px;
      flex-shrink: 0;
      border-radius: 8px;
      overflow: hidden;
      background: rgba(30,28,27,0.9);
      border: 1px solid rgba(68,65,63,0.5);
      margin-left: -4px;
    }
    .mod-card-image-wrap img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .remove-progress-bar {
      display: none;
      background: rgba(0,0,0,0.5);
      border: 1px solid rgba(68,65,63,0.5);
      border-radius: 8px;
      padding: 14px 18px;
      margin-bottom: 12px;
    }
    .remove-progress-bar .remove-msg {
      font-size: 0.85rem;
      color: rgba(244,240,235,0.9);
      margin-bottom: 6px;
    }
    .remove-progress-bar .remove-details {
      font-size: 0.75rem;
      color: rgba(200,196,192,0.5);
      margin-bottom: 8px;
    }
    .remove-progress-bar .remove-track {
      width: 100%;
      height: 6px;
      background: rgba(68,65,63,0.4);
      border-radius: 3px;
      overflow: hidden;
      position: relative;
    }
    .remove-progress-bar .remove-fill {
      height: 100%;
      background: linear-gradient(90deg, #f97316, #fb923c);
      border-radius: 3px;
      transition: width 0.3s ease;
      width: 0%;
    }
    .remove-progress-bar .remove-fill.indeterminate {
      width: 30%;
      position: absolute;
      animation: removeIndeterminate 2s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }
    @keyframes removeIndeterminate {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(333%); }
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: rgba(200,196,192,0.6);
      grid-column: 1 / -1;
    }

    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 16px;
      opacity: 0.3;
    }

    .empty-state-text {
      font-size: 1.1rem;
    }

    .settings-btn[data-hidden] { opacity: 0; pointer-events: none; visibility: hidden; }

    .msg-popup .popup-actions { justify-content: center; }
    .msg-popup .popup-content { color: rgba(244, 240, 235, 0.92); line-height: 1.6; }
    

    .btn-remove {
      background: linear-gradient(145deg, rgba(220,38,38,0.3), rgba(180,20,20,0.2));
      border-color: rgba(220,38,38,0.5);
    }

    .btn-remove:hover {
      background: linear-gradient(145deg, rgba(220,38,38,0.4), rgba(180,20,20,0.3));
      border-color: rgba(220,38,38,0.7);
    }

    .workshop-browse-container {
      margin-bottom: 30px;
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }

    .workshop-browse-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      }

    .workshop-browse-title {
      color: rgba(249,115,22,0.9);
      font-size: 1rem;
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .workshop-browse-controls {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
    }
    .workshop-browse-controls > * { margin-right: 8px; }
    .workshop-browse-controls > *:last-child { margin-right: 0; }

    .workshop-search-wrap {
      position: relative;
      display: flex;
      align-items: center;
    }
    .workshop-search-wrap > * { margin-right: 8px; }
    .workshop-search-wrap > *:last-child { margin-right: 0; }

    .workshop-search-input {
      background: rgba(30,28,27,0.9);
      border: 1px solid rgba(249,115,22,0.3);
      border-radius: 8px;
      color: #fff;
      padding: 10px 12px;
      font-size: 0.9rem;
      outline: none;
      transition: all 0.2s;
      min-width: 200px;
      cursor: text !important;
      -ms-user-select: text !important;
      -webkit-user-select: text !important;
      -moz-user-select: text !important;
      user-select: text !important;
    }

    .workshop-search-input::placeholder {
      color: rgba(200,196,192,0.4);
    }

    .workshop-search-input:focus {
      border-color: rgba(249,115,22,0.6);
      background: rgba(30,28,27,0.95);
    }

    .workshop-browse-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
      flex: 1;
      min-height: 300px;
      max-height: 580px;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 10px;
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(68,65,63,0.4);
      border-radius: 8px;
      position: relative;
      scroll-behavior: smooth;
    }

    .workshop-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      z-index: 999;
    }

    .workshop-overlay.active {
      display: block;
    }

    .workshop-modal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: linear-gradient(180deg, rgba(48,46,44,0.98), rgba(32,30,28,0.98));
      border: 1px solid rgba(249,115,22,0.35);
      border-radius: 12px;
      z-index: 1000;
      max-width: 900px;
      width: 92%;
      max-height: 85vh;
      overflow: hidden;
      box-shadow: 0 12px 48px rgba(0,0,0,0.8), 0 0 0 1px rgba(68,65,63,0.3);
    }

    .workshop-modal.active {
      display: block;
    }

    .workshop-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 24px 20px;
      border-bottom: 1px solid rgba(249,115,22,0.2);
      background: linear-gradient(180deg, rgba(249,115,22,0.08), transparent);
    }

    .workshop-modal-title {
      font-size: 1.4rem;
      color: #fff;
      margin: 0;
      font-weight: 700;
      text-shadow: 0 2px 8px rgba(0,0,0,0.5);
    }

    .workshop-modal-close {
      background: none;
      border: none;
      color: rgba(200,196,192,0.6);
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .workshop-modal-close:hover {
      color: rgba(249,115,22,0.9);
      background: rgba(249,115,22,0.1);
      border-radius: 4px;
    }

    .workshop-modal-body {
      padding: 0;
    }

    .workshop-modal-content {
      display: flex;
      flex-direction: row;
      gap: 0;
    }

    .workshop-modal-image {
      width: 320px;
      min-height: 300px;
      flex-shrink: 0;
      overflow: hidden;
      background: rgba(20,18,17,0.9);
      border-right: 1px solid rgba(68,65,63,0.3);
    }

    .workshop-modal-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .workshop-modal-detail-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      min-width: 0;
      gap: 14px;
    }

    .workshop-modal-info {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .workshop-modal-info-item {
      padding: 8px 12px;
      background: rgba(20,18,17,0.7);
      border-radius: 6px;
      border: 1px solid rgba(68,65,63,0.3);
      flex: 1 1 auto;
      min-width: 0;
    }

    .workshop-modal-info-item.full-width {
      flex-basis: 100%;
    }

    .workshop-modal-info-label {
      font-size: 0.7rem;
      color: rgba(249,115,22,0.7);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 3px;
    }

    .workshop-modal-info-value {
      color: #fff;
      font-weight: 500;
      word-break: break-all;
      font-size: 0.85rem;
    }

    .workshop-modal-description {
      padding: 12px;
      background: rgba(20,18,17,0.7);
      border-radius: 6px;
      border: 1px solid rgba(68,65,63,0.3);
      color: rgba(200,196,192,0.85);
      line-height: 1.6;
      font-size: 0.85rem;
      max-height: 220px;
      overflow-y: auto;
      flex: 1;
      white-space: pre-wrap;
    }

    .workshop-modal-footer {
      padding: 14px 20px;
      border-top: 1px solid rgba(249,115,22,0.2);
      display: flex;
      justify-content: flex-end;
    }

    .workshop-modal-footer .btn:not(:last-child) {
      margin-right: 16px;
    }


    .workshop-filter-wrap {
      position: relative;
      display: inline-block;
    }
    .workshop-filter-wrap::after {
      content: "\25BC";
      position: absolute;
      right: 10px;
      top: 50%;
      margin-top: -7px;
      font-size: 11px;
      color: #f97316;
      pointer-events: none;
    }

    .workshop-filter-select {
      background: rgba(30,28,27,0.9);
      border: 1px solid rgba(249,115,22,0.3);
      border-radius: 8px;
      color: #fff;
      padding: 10px 32px 10px 12px;
      font-size: 0.9rem;
      outline: none;
      cursor: pointer;
      transition: all 0.2s;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
    }
    .workshop-filter-select::-ms-expand {
      display: none;
    }

    .workshop-filter-select:hover {
      border-color: rgba(249,115,22,0.5);
    }

    .workshop-filter-select:focus {
      border-color: rgba(249,115,22,0.6);
      background: rgba(30,28,27,0.95);
    }

    .workshop-filter-select option {
      background: rgba(30,28,27,0.95);
      color: #fff;
    }

    .workshop-item-card {
      background: rgba(42,40,38,0.8);
      border: 1px solid rgba(68,65,63,0.5);
      border-radius: 8px;
      overflow: hidden;
      display: flex;
      flex-direction: row;
      transition: all 0.2s;
      cursor: pointer;
      min-height: 100px;
      align-items: stretch;
    }

    .workshop-item-card:hover {
      background: rgba(52,50,48,0.9);
      border-color: rgba(249,115,22,0.5);
      transform: translateX(4px);
      box-shadow: 0 4px 16px rgba(249,115,22,0.2);
    }

    .workshop-item-image {
      width: 130px;
      height: auto;
      background: rgba(30,28,27,0.8);
      overflow: hidden;
      flex-shrink: 0;
    }

    .workshop-item-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .workshop-item-image .no-image {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(200,196,192,0.3);
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .workshop-item-content {
      padding: 10px 14px;
      display: flex;
      flex-direction: row;
      flex: 1;
      align-items: center;
      min-width: 0;
      gap: 10px;
    }

    .workshop-item-title {
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
      font-size: 0.95rem;
      line-height: 1.3;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .workshop-item-description {
      font-size: 0.8rem;
      color: rgba(200,196,192,0.7);
      margin-bottom: 8px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      flex: 1;
    }

    .workshop-item-id {
      font-size: 0.75rem;
      color: rgba(200,196,192,0.5);
      margin-bottom: 8px;
      font-family: monospace;
    }

    .workshop-item-button {
      background: linear-gradient(145deg, rgba(249,115,22,0.4), rgba(220,90,12,0.3));
      border: 1px solid rgba(249,115,22,0.6);
      border-radius: 4px;
      color: #fff;
      padding: 8px 12px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.2s;
      font-weight: 500;
    }

    .workshop-item-button:hover {
      background: linear-gradient(145deg, rgba(249,115,22,0.6), rgba(220,90,12,0.5));
      border-color: rgba(249,115,22,0.8);
    }

    .workshop-item-button:active {
      transform: scale(0.98);
    }

    .workshop-browse-pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-top: 14px;
      padding-bottom: 8px;
      gap: 6px;
      flex-wrap: wrap;
    }

    .workshop-browse-pagination .btn {
      min-width: 28px;
      padding: 4px 8px;
      font-size: 0.75rem;
      border-radius: 4px;
      line-height: 1.2;
    }

    .workshop-browse-pagination .btn.page-active {
      background: rgba(249,115,22,0.85);
      color: #fff;
      border-color: rgba(249,115,22,0.9);
      font-weight: 600;
    }

    .workshop-browse-pagination .page-ellipsis {
      color: rgba(200,196,192,0.4);
      font-size: 0.75rem;
      padding: 0 2px;
      user-select: none;
    }

    .workshop-browse-pagination span.page-info {
      color: rgba(200,196,192,0.4);
      font-size: 0.72rem;
      margin-left: 10px;
    }

    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(249,115,22,0.3);
      border-top-color: rgba(249,115,22,0.9);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .workshop-loading {
      grid-column: 1 / -1;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
      color: rgba(200,196,192,0.7);
      font-size: 0.95rem;
    }

    .workshop-browse-empty {
      grid-column: 1 / -1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 200px;
      color: rgba(200,196,192,0.5);
    }

    .workshop-browse-empty-icon {
      font-size: 3rem;
      margin-bottom: 12px;
      opacity: 0.6;
    }

    .btn.btn-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      white-space: nowrap;
    }

    .btn.btn-icon::before {
      font-size: 1.1em;
    }

    ::-webkit-scrollbar {
      width: 10px;
    }
    ::-webkit-scrollbar-track {
      background: rgba(20,18,17,0.7);
      border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb {
      background: rgba(249,115,22,0.5);
      border-radius: 5px;
      border: 1px solid rgba(0,0,0,0.3);
    }
    ::-webkit-scrollbar-thumb:hover {
      background: rgba(249,115,22,0.75);
    }
    ::-webkit-scrollbar-corner {
      background: transparent;
    }

    html {
      scrollbar-face-color: #c05a10;
      scrollbar-track-color: #1a1816;
      scrollbar-arrow-color: #f97316;
      scrollbar-shadow-color: #0a0a0a;
      scrollbar-highlight-color: #c05a10;
      scrollbar-3dlight-color: #1a1816;
      scrollbar-darkshadow-color: #0a0a0a;
    }

    .workshop-browse-grid,
    .mods-grid-wrap,
    .content-area,
    .workshop-modal {
      scrollbar-face-color: #c05a10;
      scrollbar-track-color: #1a1816;
      scrollbar-arrow-color: #f97316;
      scrollbar-shadow-color: #0a0a0a;
      scrollbar-highlight-color: #c05a10;
      scrollbar-3dlight-color: #1a1816;
      scrollbar-darkshadow-color: #0a0a0a;
      scrollbar-color: rgba(249,115,22,0.5) rgba(20,18,17,0.7);
      scrollbar-width: thin;
    }

    </style>
</head>
<body>
  <button type="button" class="settings-btn" id="settingsBtn" title="Launch Options" data-show-on="main">
    <svg viewBox="0 0 24 24"><path d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.53c.03-.3.07-.64.07-1s-.04-.7-.07-1l2.11-1.63c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64L4.57 11c-.03.3-.07.67-.07 1s.02.7.07 1l-2.11 1.66c-.19.15-.25.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1.01c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.58 1.69-.98l2.49 1.01c.22.08.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.66z"/></svg>
  </button>

        <div class="settings-dropdown" id="settingsDropdown">
    <h4>Launch Options</h4>
          <div class="option-btn" data-option="nointro"><span class="dot"></span><span class="label">Skip Intro</span></div>
          <div class="option-btn" data-option="unsafe-lua"><span class="dot"></span><span class="label">Load Lua</span></div>
          <div class="option-btn" data-option="nosteam"><span class="dot"></span><span class="label">No Steam</span></div>
          <div class="option-btn" data-option="windowed"><span class="dot"></span><span class="label">Windowed</span></div>
          <div class="option-btn" data-option="borderless"><span class="dot"></span><span class="label">Borderless</span></div>
          <div class="option-btn" data-option="safe-mode"><span class="dot"></span><span class="label">Safe Mode</span></div>
          <div class="option-btn" data-option="console"><span class="dot"></span><span class="label">Dev</span></div>
          <div class="option-btn" data-option="headless"><span class="dot"></span><span class="label">Headless</span></div>
          <div class="option-btn" data-option="trimlogs"><span class="dot"></span><span class="label">Trim Logs</span></div>
          <div class="option-btn" data-option="nologs"><span class="dot"></span><span class="label">No Console</span></div>
          <div class="option-btn" data-option="keeplauncher"><span class="dot"></span><span class="label">Keep Launcher</span></div>
          <div class="option-btn" data-option="plugins"><span class="dot"></span><span class="label">Plugins</span></div>
        </div>

  <div class="main-container">
    <div class="nav-sidebar">
      <button class="nav-btn active" data-page="main">
        <span class="nav-icon">&#127968;</span>
        <span>Main</span>
      </button>
      <button class="nav-btn" data-page="workshop">
        <span class="nav-icon">&#128230;</span>
        <span>Workshop</span>
      </button>
      <button class="nav-btn" data-page="library">
        <span class="nav-icon">&#128218;</span>
        <span>Library</span>
      </button>
    </div>

    <div class="content-area">
      <div id="mainPage" class="page active">
        <h1 style="margin-bottom: 10px;">
          <span class="big-e white">E</span><span class="white">ZZ</span>
          <span class="orange"> </span><span class="orange">B</span><span class="orange">O</span><span class="orange">I</span><span class="orange">I</span><span class="orange">I</span>
        </h1>
        <p class="description" style="margin-bottom: 28px;">
          Call of Duty: Black Ops 3 enhanced with our modifications. Experience the full campaign, multiplayer, and zombies modes with improved stability and additional features.
        </p>

        <div class="main-content">
          <div class="play-section">
            <button type="button" class="btn-play-large" id="playBtn">&#9654; PLAY</button>
          </div>

          <div class="player-section">
            <div class="player-label">Player Name</div>
            <div class="input-wrap">
              <div class="corner-bl"></div>
              <div class="corner-br"></div>
              <input type="text" class="player-input" id="playerName" placeholder="Enter your name..." maxlength="16" autocomplete="off" spellcheck="false">
            </div>
          </div>

          <div class="action-buttons">
            <button type="button" class="btn discord" id="discordBtn" onclick="window.external.openUrl('https://discord.gg/ezz')">Discord</button>
            <button type="button" class="btn forum" onclick="window.external.openUrl('https://ezz.lol')">Forum</button>
            <button type="button" class="btn" id="manageInstallBtn">Manage</button>
          </div>

          <button type="button" class="btn" id="verifyBtn" style="width:100%;max-width:440px;padding:10px 8px;font-size:0.82rem;margin-top:10px;">Verify Game Files</button>
          <button type="button" class="btn" id="setPathBtn" style="width:100%;max-width:440px;padding:10px 8px;font-size:0.82rem;margin-top:6px;">Set Game Path</button>
          <div id="currentPathDisplay" style="text-align:center;font-size:0.72rem;color:rgba(255,255,255,0.35);margin-top:4px;max-width:440px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"></div>
        </div>
      </div>

      <div id="workshopPage" class="page">
        <h2>Workshop</h2>
        <p class="description" style="text-align:left;max-width:600px;">
          Browse, download, and manage custom maps and mods from the Steam Workshop.
        </p>

        <div style="margin: 0 0 24px 0; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 8px; border: 1px solid rgba(68,65,63,0.3); position: relative; z-index: 10;">
          <h3 style="color: rgba(249,115,22,0.9); font-size: 1rem; margin-bottom: 16px; margin-top: 0; text-transform: uppercase; letter-spacing: 0.1em;">Quick Download</h3>
          <p class="description" style="text-align:left;margin: 0 0 12px 0;">Download by ID or workshop link</p>

          <div class="workshop-input-row">
            <input type="text" id="workshopId" placeholder="Enter Workshop ID or link..." autocomplete="off">
            <button type="button" class="btn primary" id="workshopDownloadBtn" style="min-width: 120px; padding: 12px 24px; font-size: 0.95rem;">Download</button>
          </div>

          <div class="workshop-progress" id="workshopProgress" style="display: none; margin-top: 14px;">
            <div id="workshopStatusMessage" style="color: rgba(249,115,22,0.9); font-weight: 600; font-size: 0.9rem; margin-bottom: 6px;"></div>
            <div class="workshop-progress-bar" style="display: flex; align-items: center;">
              <div style="flex: 1; height: 20px; position: relative; background: rgba(68,65,63,0.5); border-radius: 4px; overflow: hidden; margin-right: 10px;">
                <div class="workshop-progress-fill" id="workshopProgressFill"></div>
                <span id="workshopProgressPercent" style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.75rem; color: #fff; font-weight: 600; text-shadow: 0 1px 3px rgba(0,0,0,0.8);"></span>
              </div>
              <button type="button" class="btn" id="workshopProgressCancel" title="Cancel download" style="min-width: 38px; padding: 8px 0;">&times;</button>
            </div>
            <div id="workshopStatusDetails" style="font-size: 0.8rem; color: rgba(200,196,192,0.7); margin-top: 4px;"></div>
            <div class="workshop-status" id="workshopStatus" style="display:none;"></div>
          </div>
        </div>

        <div class="workshop-browse-container">
          <div class="workshop-browse-header">
            <h3 class="workshop-browse-title">Browse Workshop</h3>
            <div class="workshop-browse-controls">
              <div class="workshop-search-wrap">
                <div class="workshop-filter-wrap">
                <select id="workshopFilterSelect" class="workshop-filter-select">
                  <option value="mostrecent">Most Recent</option>
                  <option value="trend">Top Rated</option>
                  <option value="oldest">Oldest</option>
                  <option value="alphabetical">Alphabetical</option>
                </select>
                </div>
                <input type="text" id="workshopSearchInput" class="workshop-search-input" placeholder="Search by name..." autocomplete="off">
                <button type="button" class="btn" id="workshopSearchBtn" title="Search workshop">Search</button>
              </div>
              <button type="button" class="btn btn-icon" id="workshopBrowseRefreshBtn" title="Refresh workshop list">
                <span>â†» Refresh</span>
              </button>
              <button type="button" class="btn" id="workshopBrowseClearBtn" title="Clear cache">Clear</button>
            </div>
          </div>

          <div class="workshop-browse-grid" id="workshopBrowseGrid">
            <div class="workshop-loading">
              <div class="loading-spinner"></div>
              <span>Loading workshop items...</span>
            </div>
          </div>

          <div class="workshop-browse-pagination" id="workshopBrowsePagination" style="display: none;"></div>
        </div>

        <div id="workshopOverlay" class="workshop-overlay"></div>
        <div id="workshopModal" class="workshop-modal">
          <div class="workshop-modal-header">
            <h2 class="workshop-modal-title" id="workshopModalTitle">Mod Details</h2>
            <button type="button" class="workshop-modal-close" id="workshopModalClose">&times;</button>
          </div>
          <div class="workshop-modal-body">
            <div class="workshop-modal-content">
              <div class="workshop-modal-image" id="workshopModalImage"></div>
              <div class="workshop-modal-detail-panel">
                <div class="workshop-modal-info" id="workshopModalInfo"></div>
                <div class="workshop-modal-description" id="workshopModalDescription"></div>
              </div>
            </div>
          </div>
          <div class="workshop-modal-footer">
            <button type="button" class="btn" id="workshopModalViewBtn">View on Steam</button>
            <button type="button" class="btn primary" id="workshopModalDownloadBtn">Download</button>
          </div>
        </div>
      </div>

      <div id="libraryPage" class="page">
        <h2>Library</h2>
        <p class="description" style="text-align:left;max-width:600px;">
          Browse and manage your installed workshop maps and mods.
        </p>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; row-gap: 8px;">
          <h3 style="color: rgba(249,115,22,0.9); font-size: 1rem; margin: 0; text-transform: uppercase; letter-spacing: 0.1em;">Installed Items</h3>
          <div style="display: flex; flex-wrap: wrap;">
            <button type="button" class="btn" id="workshopRefreshBtn" title="Refresh list" style="margin: 0 4px 4px 0;">Refresh</button>
            <button type="button" class="btn" id="workshopLinkBtn" style="background: linear-gradient(145deg, rgba(30,80,150,0.5), rgba(20,60,120,0.4)); border-color: rgba(66,133,244,0.6); margin: 0 4px 4px 0;" onclick="window.external.openUrl('https://steamcommunity.com/app/311210/workshop/')">Workshop</button>
            <button type="button" class="btn" id="checkUpdatesBtn" style="margin: 0 4px 4px 0;">Check for updates</button>
            <button type="button" class="btn btn-remove" id="deleteAllModsBtn" style="margin: 0 0 4px 0;">Delete all</button>
          </div>
        </div>
        <div class="remove-progress-bar" id="removeProgressBar">
          <div class="remove-msg" id="removeMsg"></div>
          <div class="remove-details" id="removeDetails"></div>
          <div class="remove-track"><div class="remove-fill" id="removeFill"></div></div>
        </div>
        <div class="mods-grid-wrap">
          <div class="mods-grid" id="modsGrid"></div>
        </div>
        <div class="mods-pagination" id="modsPagination" style="display: none;">
          <button type="button" class="btn" id="modsPrevPageBtn">Prev</button>
          <span id="modsPageLabel">Page 1 / 1</span>
          <button type="button" class="btn" id="modsNextPageBtn">Next</button>
        </div>
      </div>
    </div>
  </div>

  <div class="progress-footer" id="progressFooter">
    <div class="progress-info" id="progressInfo">Ready</div>
    <div class="progress-bar-container">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <div class="progress-percent" id="progressPercent">0%</div>
    <button type="button" class="progress-folder" id="progressOpenFolder" title="Open download folder">&#128194;</button>
    <button type="button" class="progress-cancel" id="progressCancel">Ã—</button>
  </div>

  <div class="popup-backdrop" id="manageInstallPopup">
    <div class="popup component-selection-popup">
      <div class="popup-header">
        <h3>Manage Installation</h3>
        <button type="button" class="popup-close">&times;</button>
      </div>
      <div class="popup-content">
        <div class="component-selection-section">
          <div class="section-header">
            <label>Select game modes to remove</label>
          </div>
          <div class="components-list" id="componentsList"></div>
        </div>
        <div class="popup-actions">
          <button type="button" class="btn" id="popupCancel">Cancel</button>
          <button type="button" class="btn danger" id="popupApply">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <div class="popup-backdrop" id="verifyPopup">
    <div class="popup verify-popup" style="width:420px;">
      <div class="popup-header">
        <h3>Verify Game Files</h3>
        <button type="button" class="popup-close" id="verifyPopupClose">&times;</button>
      </div>
      <div class="popup-content">
        <div class="verify-mode-group">
          <label class="verify-group-label">Select Game Mode</label>
          <div class="verify-mode-list">
            <button type="button" class="verify-mode-btn selected" data-mode="all">All</button>
            <button type="button" class="verify-mode-btn" data-mode="zm_">Zombies</button>
            <button type="button" class="verify-mode-btn" data-mode="mp_">Multiplayer</button>
            <button type="button" class="verify-mode-btn" data-mode="cp_">Campaign</button>
          </div>
        </div>
        <div class="verify-progress-section" id="verifyProgressSection">
          <div class="verify-status-msg" id="verifyStatusMsg"></div>
          <div class="verify-progress-bar">
            <div class="verify-progress-fill" id="verifyProgressFill"></div>
            <span class="verify-progress-pct" id="verifyProgressPct">0%</span>
          </div>
          <div class="verify-status-details" id="verifyStatusDetails"></div>
        </div>
        <div class="verify-results" id="verifyResults"></div>
        <div class="verify-actions">
          <button type="button" class="btn" id="verifyCancelBtn" style="display:none;">Cancel</button>
          <button type="button" class="btn primary" id="verifyStartBtn">Start Verification</button>
        </div>
      </div>
    </div>
  </div>

  <div class="popup-backdrop" id="messagePopup">
    <div class="popup msg-popup">
      <div class="popup-header">
        <h3 id="messagePopupTitle">Message</h3>
        <button type="button" class="popup-close" data-close="messagePopup">&times;</button>
      </div>
      <div class="popup-content">
        <p id="messagePopupBody"></p>
      </div>
      <div class="popup-actions">
        <button type="button" class="btn primary" id="messagePopupOk">OK</button>
      </div>
    </div>
  </div>

  <div class="popup-backdrop" id="confirmPopup">
    <div class="popup confirm-popup">
      <div class="popup-header">
        <h3 id="confirmPopupTitle">Confirm</h3>
        <button type="button" class="popup-close" data-close="confirmPopup">&times;</button>
      </div>
      <div class="popup-content">
        <p id="confirmPopupBody"></p>
      </div>
      <div class="popup-actions">
        <button type="button" class="btn" id="confirmPopupCancel">Cancel</button>
        <button type="button" class="btn primary" id="confirmPopupConfirm">Confirm</button>
      </div>
    </div>
  </div>

  <div class="version" id="versionDisplay">v1.0.0</div>

        <script>
    (function() {
      var playerName = document.getElementById('playerName');
      var workshopId = document.getElementById('workshopId');
      var workshopStatus = document.getElementById('workshopStatus');
      var modsGrid = document.getElementById('modsGrid');
      var workshopDownloadBtn = document.getElementById('workshopDownloadBtn');
      var workshopProgress = document.getElementById('workshopProgress');
      var workshopProgressFill = document.getElementById('workshopProgressFill');
      var progressFooter = document.getElementById('progressFooter');
      var progressInfo = document.getElementById('progressInfo');
      var progressFill = document.getElementById('progressFill');
      var progressPercent = document.getElementById('progressPercent');
      var progressOpenFolder = document.getElementById('progressOpenFolder');
      var _workshopDownloadFolder = '';
      var manageInstallPopup = document.getElementById('manageInstallPopup');
      var dropdown = document.getElementById('settingsDropdown');
      var options = dropdown ? dropdown.querySelectorAll('.option-btn') : [];
      var modsPagination = document.getElementById('modsPagination');
      var modsPrevPageBtn = document.getElementById('modsPrevPageBtn');
      var modsNextPageBtn = document.getElementById('modsNextPageBtn');
      var modsPageLabel = document.getElementById('modsPageLabel');
      var modsItemsCache = [];
      var modsPage = 1;
      var modsPageSize = 12;

      var workshopBrowseGrid = document.getElementById('workshopBrowseGrid');
      var workshopSearchInput = document.getElementById('workshopSearchInput');
      var workshopSearchBtn = document.getElementById('workshopSearchBtn');
      var workshopBrowseRefreshBtn = document.getElementById('workshopBrowseRefreshBtn');
      var workshopBrowseClearBtn = document.getElementById('workshopBrowseClearBtn');
      var workshopBrowsePagination = document.getElementById('workshopBrowsePagination');
      var workshopBrowseItems = [];
      var workshopBrowseCurrentPage = 1;
      var workshopBrowseItemsPerPage = 8;
      var workshopBrowseLoading = false;
      var workshopBrowseSearchTerm = '';
      var workshopBrowseCacheKey = 'workshopBrowseCache';
      var _workshopBrowsePollInterval = null;
      var workshopBrowseCacheExpire = 86400000;

      var workshopOverlay = document.getElementById('workshopOverlay');
      var workshopModal = document.getElementById('workshopModal');
      var workshopModalTitle = document.getElementById('workshopModalTitle');
      var workshopModalClose = document.getElementById('workshopModalClose');
      var workshopModalImage = document.getElementById('workshopModalImage');
      var workshopModalInfo = document.getElementById('workshopModalInfo');
      var workshopModalDescription = document.getElementById('workshopModalDescription');
      var workshopModalViewBtn = document.getElementById('workshopModalViewBtn');
      var workshopModalDownloadBtn = document.getElementById('workshopModalDownloadBtn');
      var workshopFilterSelect = document.getElementById('workshopFilterSelect');

      if (!Array.prototype.find) {
        Array.prototype.find = function(predicate) {
          if (this == null) throw new TypeError('Array.prototype.find called on null or undefined');
          if (typeof predicate !== 'function') throw new TypeError(predicate + ' is not a function');
          var list = Object(this);
          var length = parseInt(list.length, 10) || 0;
          var thisArg = arguments.length > 1 ? arguments[1] : void undefined;
          for (var i = 0; i < length; i++) {
            var element = list[i];
            if (predicate.call(thisArg, element, i, list)) return element;
          }
          return undefined;
        };
      }

      if (!Element.prototype.closest) {
        Element.prototype.closest = function(selector) {
          var el = this;
          while (el && el.nodeType === 1) {
            if (el.matches && el.matches(selector)) return el;
            if (el.msMatchesSelector && el.msMatchesSelector(selector)) return el;
            el = el.parentElement;
          }
          return null;
        };
      }

      function enableClipboard(element) {
        if (!element) return;
        element.oncopy = null;
        element.oncut = null;
        element.onpaste = null;
        element.setAttribute('unselectable', 'off');
        element.onselectstart = function() { return true; };
        element.style.userSelect = 'text';
        element.style.webkitUserSelect = 'text';
        element.style.MozUserSelect = 'text';
        element.style.msUserSelect = 'text';
        element.style.cursor = 'text';
        if (!element.hasAttribute('tabindex')) {
          element.setAttribute('tabindex', '0');
        }
      }

      function escapeHtml(str) {
        if (!str) return '';
        return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
      }

      function saveWorkshopCache(items) {
        try {
          localStorage.setItem(workshopBrowseCacheKey, JSON.stringify({
            timestamp: Date.now(),
            items: items
          }));
        } catch (e) {}
      }

      function loadWorkshopCache() {
        try {
          var cached = localStorage.getItem(workshopBrowseCacheKey);
          if (!cached) return null;
          var data = JSON.parse(cached);
          return data.items || null;
        } catch (e) {
          return null;
        }
      }

      function showWorkshopModal(item) {
        if (!item) return;
        workshopModalTitle.textContent = item.title || 'Untitled';
        
        if (item.imageUrl) {
          workshopModalImage.innerHTML = '<img src="' + escapeHtml(item.imageUrl) + '" alt="">';
          var _modalImg = workshopModalImage.querySelector('img');
          if (_modalImg) {
            _modalImg.onerror = function() {
              this.onerror = null;
              workshopModalImage.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:rgba(200,196,192,0.3);font-size:2.5rem;">No Image</div>';
            };
          }
          workshopModalImage.style.display = 'block';
        } else {
          workshopModalImage.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:rgba(200,196,192,0.3);font-size:2.5rem;">No Image</div>';
          workshopModalImage.style.display = 'block';
        }
        
        var modalRatingHtml = '<span style="color:rgba(200,196,192,0.6);">N/A</span>';
        var mSr = parseInt(item.starRating, 10) || 0;
        if (mSr > 0) {
          var mStarStr = '';
          for (var ms = 0; ms < mSr; ms++) mStarStr += '\u2605';
          for (var ms = mSr; ms < 5; ms++) mStarStr += '\u2606';
          var mColor = mSr >= 4 ? 'rgba(34,197,94,0.9)' : (mSr >= 3 ? 'rgba(250,204,21,0.9)' : 'rgba(239,68,68,0.9)');
          modalRatingHtml = '<span style="color:' + mColor + ';">' + mStarStr + ' (' + mSr + '/5)</span>';
        } else {
          modalRatingHtml = '<span style="color:rgba(200,196,192,0.6);">Not enough ratings</span>';
        }

        var modalSubsHtml = '';
        var mSubs = parseInt(item.subs, 10) || 0;
        var mFavs = parseInt(item.favorites, 10) || 0;
        if (mSubs > 0 || mFavs > 0) {
          modalSubsHtml = '<div class="workshop-modal-info-item">' +
            '<div class="workshop-modal-info-label">Popularity</div>' +
            '<div class="workshop-modal-info-value">' + (mSubs > 0 ? mSubs.toLocaleString() + ' subs' : '') + (mSubs > 0 && mFavs > 0 ? ' &middot; ' : '') + (mFavs > 0 ? mFavs.toLocaleString() + ' favs' : '') + '</div>' +
          '</div>';
        }

        var modalSizeHtml = '';
        var mSize = parseInt(item.file_size, 10) || 0;
        if (mSize > 0) {
          var sizeStr = mSize > 1073741824 ? (mSize / 1073741824).toFixed(2) + ' GB' :
            mSize > 1048576 ? (mSize / 1048576).toFixed(1) + ' MB' :
            mSize > 1024 ? (mSize / 1024).toFixed(0) + ' KB' : mSize + ' B';
          modalSizeHtml = '<div class="workshop-modal-info-item">' +
            '<div class="workshop-modal-info-label">Size</div>' +
            '<div class="workshop-modal-info-value">' + sizeStr + '</div>' +
          '</div>';
        }

        workshopModalInfo.innerHTML = 
          '<div class="workshop-modal-info-item">' +
            '<div class="workshop-modal-info-label">Workshop ID</div>' +
            '<div class="workshop-modal-info-value" style="font-family:monospace;font-size:0.85rem;">' + escapeHtml(item.id || 'N/A') + '</div>' +
          '</div>' +
          '<div class="workshop-modal-info-item">' +
            '<div class="workshop-modal-info-label">Rating</div>' +
            '<div class="workshop-modal-info-value">' + modalRatingHtml + '</div>' +
          '</div>' +
          modalSubsHtml +
          modalSizeHtml;
        
        workshopModalDescription.textContent = item.description || 'No description available';
        
        workshopModalViewBtn.onclick = function() {
          try { window.external.openUrl('https://steamcommunity.com/sharedfiles/filedetails/?id=' + item.id); } catch (e) {}
        };
        
        workshopModalDownloadBtn.onclick = function() {
          hideWorkshopModal();
          startWorkshopDownload(item.id, item.title);
        };
        
        workshopOverlay.classList.add('active');
        workshopModal.classList.add('active');
      }

      function hideWorkshopModal() {
        workshopOverlay.classList.remove('active');
        workshopModal.classList.remove('active');
      }
      
      enableClipboard(playerName);
      enableClipboard(workshopId);
      enableClipboard(workshopSearchInput);

      function getExternal() {
        try { return window.external; } catch (e) { return null; }
      }

      function cancelWorkshopPoll() {
        if (_workshopBrowsePollInterval) {
          clearInterval(_workshopBrowsePollInterval);
          _workshopBrowsePollInterval = null;
        }
        workshopBrowseLoading = false;
      }

      function loadWorkshopBrowse(page, searchTerm, filter) {
        cancelWorkshopPoll();
        workshopBrowseLoading = true;
        workshopBrowseCurrentPage = page || 1;
        workshopBrowseSearchTerm = '';
        
        if (workshopBrowseItems.length === 0) {
          showWorkshopLoading();
        }

        try {
          var ex = getExternal();
          if (ex && ex.workshopBrowse) {
            ex.workshopBrowse(workshopBrowseCurrentPage);
            pollWorkshopBrowseResults();
          }
        } catch (e) {
          workshopBrowseLoading = false;
          showErrorOrCache('Workshop browsing not available. Showing cached mods...');
        }
      }

      function loadWorkshopSearch(query) {
        if (!query || !query.trim()) return;
        cancelWorkshopPoll();
        workshopBrowseLoading = true;
        workshopBrowseSearchTerm = '';
        workshopBrowseCurrentPage = 1;
        
        showWorkshopLoading();

        try {
          var ex = getExternal();
          if (ex && ex.workshopSearch) {
            ex.workshopSearch(query.trim());
            pollWorkshopBrowseResults();
          } else {
            workshopBrowseLoading = false;
            workshopBrowseSearchTerm = query.trim();
            renderWorkshopBrowse();
          }
        } catch (e) {
          workshopBrowseLoading = false;
          workshopBrowseSearchTerm = query.trim();
          renderWorkshopBrowse();
        }
      }

      function pollWorkshopBrowseResults() {
        if (_workshopBrowsePollInterval) {
          clearInterval(_workshopBrowsePollInterval);
          _workshopBrowsePollInterval = null;
        }
        var pollCount = 0;
        var maxPolls = 600;
        var hasShownCachedData = workshopBrowseItems.length > 0;
        var pollInterval = setInterval(function() {
          pollCount++;
          _workshopBrowsePollInterval = pollInterval;
          
          if (!hasShownCachedData && pollCount === 20) {
            try {
              var ex3 = getExternal();
              if (ex3 && ex3.workshopGetBrowseData) {
                var cachedJson = ex3.workshopGetBrowseData();
                if (cachedJson && cachedJson !== '[]') {
                  var cachedData = typeof cachedJson === 'string' ? JSON.parse(cachedJson) : cachedJson;
                  if (cachedData && Array.isArray(cachedData) && cachedData.length > 0) {
                    workshopBrowseItems = cachedData;
                    hasShownCachedData = true;
                    workshopBrowseCurrentPage = 1;
                    renderWorkshopBrowse();
                  }
                }
              }
            } catch (e) {}
          }
          
          if (pollCount > maxPolls) {
            clearInterval(pollInterval);
            workshopBrowseLoading = false;
            if (workshopBrowseItems.length === 0) {
              showErrorOrCache('Loading took too long. Showing cached mods...');
            }
            return;
          }

          try {
            var ex2 = getExternal();
            if (ex2 && ex2.workshopGetBrowseData) {
              var dataJson = ex2.workshopGetBrowseData();
              var isLoading = ex2.workshopIsBrowseLoading && ex2.workshopIsBrowseLoading() === 'true';
              
              if (!isLoading && dataJson) {
                clearInterval(pollInterval);
                var data = typeof dataJson === 'string' ? JSON.parse(dataJson) : dataJson;
                if (data && Array.isArray(data) && data.length > 0) {
                  workshopBrowseItems = data;
                  saveWorkshopCache(workshopBrowseItems);
                  workshopBrowseCurrentPage = 1;
                  renderWorkshopBrowse();
                } else if (workshopBrowseItems.length === 0) {
                  showErrorOrCache('No workshop items found. Showing cached mods...');
                }
                workshopBrowseLoading = false;
              }
            }
          } catch (e) {
            clearInterval(pollInterval);
            workshopBrowseLoading = false;
            if (workshopBrowseItems.length === 0) {
              showErrorOrCache('Error loading workshop data. Showing cached mods...');
            }
          }
        }, 100);
        _workshopBrowsePollInterval = pollInterval;
      }

      function showWorkshopLoading() {
        workshopBrowseGrid.innerHTML = '<div class="workshop-loading"><div class="loading-spinner"></div><span>Loading workshop items...</span></div>';
      }

      function showWorkshopEmpty(message) {
        workshopBrowseGrid.innerHTML = '<div class="workshop-browse-empty"><div class="workshop-browse-empty-icon">âœ—</div><div>' + (message || 'No items found') + '</div></div>';
        if (workshopBrowsePagination) workshopBrowsePagination.style.display = 'none';
      }

      function showErrorOrCache(errorMessage) {
        try {
          var ex = getExternal();
          if (ex && ex.workshopGetBrowseData) {
            var fileData = ex.workshopGetBrowseData();
            if (fileData && fileData !== '[]') {
              var parsed = JSON.parse(fileData);
              if (parsed && Array.isArray(parsed) && parsed.length > 0) {
                workshopBrowseItems = parsed;
                renderWorkshopBrowse();
                return;
              }
            }
          }
        } catch(e) {}
        var cached = loadWorkshopCache();
        if (cached && cached.length > 0) {
          workshopBrowseItems = cached;
          renderWorkshopBrowse();
        } else {
          showWorkshopEmpty(errorMessage);
        }
      }

      function renderWorkshopBrowse() {
        workshopBrowseGrid.innerHTML = '';

        var nonArchiveItems = workshopBrowseItems.filter(function(item) {
          if (item.title && (item.title.indexOf('**ARCHIVE**') !== -1 || item.title.indexOf('ARCHIVE') === 0)) return false;
          if (item.description && item.description.indexOf('THIS MAP IS AN ARCHIVE') !== -1) return false;
          return true;
        });

        var filteredItems = nonArchiveItems;
        if (workshopBrowseSearchTerm.length > 0) {
          var term = workshopBrowseSearchTerm.toLowerCase().trim();
          filteredItems = nonArchiveItems.filter(function(item) {
            var titleMatch = item.title && item.title.toLowerCase().indexOf(term) !== -1;
            var descMatch = item.description && item.description.toLowerCase().indexOf(term) !== -1;
            var idMatch = item.id && String(item.id).toLowerCase().indexOf(term) !== -1;
            return titleMatch || descMatch || idMatch;
          });
        }

        var sortMode = workshopFilterSelect ? workshopFilterSelect.value : 'mostrecent';
        if (sortMode === 'trend') {
          filteredItems = filteredItems.slice(0).sort(function(a, b) {
            var rA = parseInt(a.starRating, 10) || 0;
            var rB = parseInt(b.starRating, 10) || 0;
            if (rB !== rA) return rB - rA;
            return (parseInt(b.subs, 10) || 0) - (parseInt(a.subs, 10) || 0);
          });
        } else if (sortMode === 'oldest') {
          filteredItems = filteredItems.slice(0).reverse();
        } else if (sortMode === 'alphabetical') {
          filteredItems = filteredItems.slice(0).sort(function(a, b) {
            var ta = (a.title || '').toLowerCase();
            var tb = (b.title || '').toLowerCase();
            return ta < tb ? -1 : (ta > tb ? 1 : 0);
          });
        }

        if (!filteredItems || filteredItems.length === 0) {
          showWorkshopEmpty(workshopBrowseSearchTerm ? 'No items match your search' : 'No workshop items available');
          return;
        }

        var totalPages = Math.ceil(filteredItems.length / workshopBrowseItemsPerPage) || 1;
        if (workshopBrowseCurrentPage < 1) workshopBrowseCurrentPage = 1;
        if (workshopBrowseCurrentPage > totalPages) workshopBrowseCurrentPage = totalPages;

        var start = (workshopBrowseCurrentPage - 1) * workshopBrowseItemsPerPage;
        var end = Math.min(start + workshopBrowseItemsPerPage, filteredItems.length);

        for (var i = start; i < end; i++) {
          var item = filteredItems[i];
          var card = document.createElement('div');
          card.className = 'workshop-item-card';

          var imageHtml = '';
          if (item.imageUrl) {
            imageHtml = '<div class="workshop-item-image"><img src="' + escapeHtml(item.imageUrl) + '" alt=""></div>';
          } else {
            imageHtml = '<div class="workshop-item-image"><div class="no-image">No Image</div></div>';
          }

          var rawDesc = (item.description || '').replace(/[\r\n]+/g, ' ');
          var desc = rawDesc.substring(0, 80);
          if (rawDesc.length > 80) desc += '...';

          var ratingHtml = '';
          var sr = parseInt(item.starRating, 10) || 0;
          if (sr > 0) {
            var starStr = '';
            for (var s = 0; s < sr; s++) starStr += '\u2605';
            for (var s = sr; s < 5; s++) starStr += '\u2606';
            var rColor = sr >= 4 ? 'rgba(34,197,94,0.8)' : (sr >= 3 ? 'rgba(250,204,21,0.8)' : 'rgba(239,68,68,0.8)');
            ratingHtml = '<span style="font-size:0.75rem;color:' + rColor + ';margin-left:8px;" title="' + sr + '/5 stars">' + starStr + '</span>';
          }

          var fSize = parseInt(item.file_size, 10) || 0;
          var fStr = '';
          if (fSize > 0) {
            fStr = fSize > 1073741824 ? (fSize / 1073741824).toFixed(2) + ' GB' :
              fSize > 1048576 ? (fSize / 1048576).toFixed(1) + ' MB' :
              fSize > 1024 ? (fSize / 1024).toFixed(0) + ' KB' : fSize + ' B';
          }

          var contentHtml = '<div class="workshop-item-content">' +
            '<div style="flex: 1;">' +
            '<div class="workshop-item-title" title="' + escapeHtml(item.title || '') + '">' + escapeHtml(item.title || 'Untitled') + ratingHtml + '</div>' +
            (desc ? '<div style="font-size: 0.8rem; color: rgba(200,196,192,0.6); margin-top: 2px; line-height: 1.2;">' + escapeHtml(desc) + '</div>' : '') +
            '<div style="font-size: 0.75rem; color: rgba(200,196,192,0.4); margin-top: 2px;">ID: ' + escapeHtml(item.id) + '</div>' +
            '</div>' +
            '<div style="display:flex;flex-direction:column;align-items:center;flex-shrink:0;margin-left:8px;">' +
            '<button type="button" class="workshop-item-button" data-workshop-id="' + escapeHtml(item.id) + '" style="white-space: nowrap;">Download</button>' +
            (fStr ? '<span style="font-size:0.65rem;color:rgba(200,196,192,0.4);margin-top:3px;">' + fStr + '</span>' : '') +
            '</div>' +
            '</div>';

          card.innerHTML = imageHtml + contentHtml;

          var cardImg = card.querySelector('img');
          if (cardImg) {
            (function(imgEl) {
              imgEl.onerror = function() {
                this.onerror = null;
                this.parentNode.innerHTML = '<div class="no-image">No Image</div>';
              };
            })(cardImg);
          }

          workshopBrowseGrid.appendChild(card);
        }

        if (workshopBrowsePagination) {
          if (totalPages > 1) {
            workshopBrowsePagination.style.display = 'flex';
            workshopBrowsePagination.innerHTML = '';

            var prevBtn = document.createElement('button');
            prevBtn.type = 'button';
            prevBtn.className = 'btn';
            prevBtn.textContent = '\u2039 Prev';
            prevBtn.disabled = workshopBrowseCurrentPage <= 1;
            prevBtn.onclick = function() {
              if (workshopBrowseCurrentPage > 1) {
                workshopBrowseCurrentPage--;
                renderWorkshopBrowse();
                workshopBrowseGrid.scrollTop = 0;
              }
            };
            workshopBrowsePagination.appendChild(prevBtn);

            var pages = [];
            if (totalPages <= 7) {
              for (var p = 1; p <= totalPages; p++) pages.push(p);
            } else {
              pages.push(1);
              if (workshopBrowseCurrentPage > 4) pages.push('...');
              var rangeStart = Math.max(2, workshopBrowseCurrentPage - 2);
              var rangeEnd = Math.min(totalPages - 1, workshopBrowseCurrentPage + 2);
              if (workshopBrowseCurrentPage <= 4) rangeEnd = Math.min(totalPages - 1, 5);
              if (workshopBrowseCurrentPage >= totalPages - 3) rangeStart = Math.max(2, totalPages - 4);
              for (var p = rangeStart; p <= rangeEnd; p++) pages.push(p);
              if (workshopBrowseCurrentPage < totalPages - 3) pages.push('...');
              pages.push(totalPages);
            }

            for (var pi = 0; pi < pages.length; pi++) {
              if (pages[pi] === '...') {
                var dots = document.createElement('span');
                dots.className = 'page-ellipsis';
                dots.textContent = '...';
                workshopBrowsePagination.appendChild(dots);
              } else {
                var pageBtn = document.createElement('button');
                pageBtn.type = 'button';
                pageBtn.className = 'btn' + (pages[pi] === workshopBrowseCurrentPage ? ' page-active' : '');
                pageBtn.textContent = String(pages[pi]);
                pageBtn.setAttribute('data-page', pages[pi]);
                pageBtn.onclick = function() {
                  var pg = parseInt(this.getAttribute('data-page'), 10);
                  if (pg !== workshopBrowseCurrentPage) {
                    workshopBrowseCurrentPage = pg;
                    renderWorkshopBrowse();
                    workshopBrowseGrid.scrollTop = 0;
                  }
                };
                workshopBrowsePagination.appendChild(pageBtn);
              }
            }

            var nextBtn = document.createElement('button');
            nextBtn.type = 'button';
            nextBtn.className = 'btn';
            nextBtn.textContent = 'Next \u203A';
            nextBtn.disabled = workshopBrowseCurrentPage >= totalPages;
            nextBtn.onclick = function() {
              if (workshopBrowseCurrentPage < totalPages) {
                workshopBrowseCurrentPage++;
                renderWorkshopBrowse();
                workshopBrowseGrid.scrollTop = 0;
              }
            };
            workshopBrowsePagination.appendChild(nextBtn);

            var info = document.createElement('span');
            info.className = 'page-info';
            info.textContent = filteredItems.length + ' items';
            workshopBrowsePagination.appendChild(info);
          } else {
            workshopBrowsePagination.style.display = 'none';
          }
        }
      }

      function doStartWorkshopDownload(id, displayName) {
        try {
          var ex = getExternal();
          if (ex && ex.workshopDownload) {
            if (ex.workshopCheckInstalled) {
              var installed = ex.workshopCheckInstalled(String(id));
              if (installed && installed.length > 0) {
                showMessage('Already Installed', 'This workshop item is already installed at:\n' + installed + '\n\nRemove it first if you want to reinstall.');
                return;
              }
            }
            ex.workshopDownload(String(id));

            var msgEl = document.getElementById('workshopStatusMessage');
            var detEl = document.getElementById('workshopStatusDetails');
            var pctEl = document.getElementById('workshopProgressPercent');
            if (msgEl) { msgEl.textContent = 'Initializing...'; msgEl.style.color = 'rgba(249,115,22,0.9)'; }
            if (detEl) detEl.textContent = 'Workshop ID: ' + id;
            if (pctEl) pctEl.textContent = '';
            window._lastWorkshopTerminalState = '';

            window._wsMaxProgress = 0;
            window._wsIndeterminate = true;
            workshopProgress.style.display = 'block';
            workshopProgressFill.style.width = '0%';
            workshopProgressFill.classList.add('indeterminate');
            workshopDownloadBtn.disabled = true;
            showProgress('Starting download for ' + (displayName || id) + '...', -1);

            if (window._workshopPollInterval) {
              clearInterval(window._workshopPollInterval);
              window._workshopPollInterval = null;
            }
            window._workshopPollInterval = setInterval(function() {
              pollWorkshopStatus();
              try {
                var ex2 = getExternal();
                if (ex2 && ex2.workshopGetStatus) {
                  var statusJson = ex2.workshopGetStatus();
                  if (statusJson) {
                    var status = typeof statusJson === 'string' ? JSON.parse(statusJson) : statusJson;
                    if (status.message && (status.message.indexOf('Done') !== -1 || status.message.indexOf('Error') !== -1 || status.message.indexOf('Canceled') !== -1 || status.message.indexOf('Already installed') !== -1)) {
                      clearInterval(window._workshopPollInterval);
                      window._workshopPollInterval = null;
                      workshopDownloadBtn.disabled = false;
                    }
                  }
                }
              } catch (e) {
                clearInterval(window._workshopPollInterval);
                window._workshopPollInterval = null;
                workshopDownloadBtn.disabled = false;
              }
            }, 500);
          }
        } catch (e) {
          console.error('Error starting workshop download:', e);
        }
      }

      function startWorkshopDownload(id, displayName) {
        if (window._workshopPollInterval) {
          showConfirm('Download in progress', 'A download is already in progress. Stop it and download "' + (displayName || id) + '" instead?', function() {
            stopWorkshopDownloadCompletely();
            setTimeout(function() { doStartWorkshopDownload(id, displayName); }, 300);
          });
          return;
        }
        doStartWorkshopDownload(id, displayName);
      }

      if (workshopModalClose) {
        workshopModalClose.onclick = hideWorkshopModal;
      }
      if (workshopOverlay) {
        workshopOverlay.onclick = hideWorkshopModal;
      }
      if (workshopModal) {
        workshopModal.onclick = function(e) { e.stopPropagation(); };
      }

      if (workshopFilterSelect) {
        workshopFilterSelect.onchange = function() {
          workshopBrowseCurrentPage = 1;
          renderWorkshopBrowse();
        };
      }

      workshopBrowseGrid.onmousewheel = function(e) {
        var delta = e.wheelDelta || -e.detail;
        var st = this.scrollTop;
        var sh = this.scrollHeight;
        var ch = this.clientHeight;
        if (delta > 0 && st <= 0) { e.preventDefault ? e.preventDefault() : (e.returnValue = false); return false; }
        if (delta < 0 && st + ch >= sh) { e.preventDefault ? e.preventDefault() : (e.returnValue = false); return false; }
      };

      var modsGridWrap = document.querySelector('.mods-grid-wrap');
      if (modsGridWrap) {
        modsGridWrap.onmousewheel = function(e) {
          var delta = e.wheelDelta || -e.detail;
          var st = this.scrollTop;
          var sh = this.scrollHeight;
          var ch = this.clientHeight;
          if (delta > 0 && st <= 0) { e.preventDefault ? e.preventDefault() : (e.returnValue = false); return false; }
          if (delta < 0 && st + ch >= sh) { e.preventDefault ? e.preventDefault() : (e.returnValue = false); return false; }
        };
      }

      if (workshopSearchBtn) {
        workshopSearchBtn.onclick = function() {
          var searchTerm = workshopSearchInput ? workshopSearchInput.value.trim() : '';
          if (!searchTerm) {
            workshopBrowseSearchTerm = '';
            workshopBrowseCurrentPage = 1;
            if (workshopBrowseItems.length > 0) {
              renderWorkshopBrowse();
            } else {
              loadWorkshopBrowse(1);
            }
            return;
          }
          loadWorkshopSearch(searchTerm);
        };
      }

      if (workshopSearchInput) {
        workshopSearchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            workshopSearchBtn.click();
          }
        });
      }

      if (workshopBrowseRefreshBtn) {
        workshopBrowseRefreshBtn.onclick = function() {
          workshopBrowseSearchTerm = '';
          if (workshopSearchInput) workshopSearchInput.value = '';
          workshopBrowseCurrentPage = 1;
          loadWorkshopBrowse(1);
        };
      }

      if (workshopBrowseClearBtn) {
        workshopBrowseClearBtn.onclick = function() {
          workshopBrowseItems = [];
          workshopBrowseSearchTerm = '';
          workshopBrowseCurrentPage = 1;
          if (workshopSearchInput) workshopSearchInput.value = '';
          try { localStorage.removeItem(workshopBrowseCacheKey); } catch(e) {}
          loadWorkshopBrowse(1);
        };
      }

      workshopBrowseGrid.addEventListener('click', function(e) {
        var btn = e.target.closest('.workshop-item-button');
        if (btn) {
          var id = btn.getAttribute('data-workshop-id');
          if (id) {
            var foundItem = null;
            for (var i = 0; i < workshopBrowseItems.length; i++) {
              if (workshopBrowseItems[i].id === id) {
                foundItem = workshopBrowseItems[i];
                break;
              }
            }
            startWorkshopDownload(id, foundItem ? foundItem.title : id);
          }
          e.preventDefault();
          e.stopPropagation();
          return;
        }
        var card = e.target.closest('.workshop-item-card');
        if (card) {
          var cardId = card.querySelector('.workshop-item-button');
          var cid = cardId ? cardId.getAttribute('data-workshop-id') : null;
          if (cid) {
            var foundItem = null;
            for (var i = 0; i < workshopBrowseItems.length; i++) {
              if (workshopBrowseItems[i].id === cid) {
                foundItem = workshopBrowseItems[i];
                break;
              }
            }
            if (foundItem) showWorkshopModal(foundItem);
          }
          e.preventDefault();
          e.stopPropagation();
        }
      });

      window.getPlayerName = function() {
        if (!playerName) return '';
        return (playerName.value || '').trim();
      };

      window.getSelectedLaunchOption = function() {
        var selected = [];
        for (var i = 0; i < options.length; i++) {
          if (options[i].classList.contains('active')) {
            var opt = options[i].getAttribute('data-option') || '';
            if (opt) selected.push(opt);
          }
        }
        return selected.join(' ');
      };

      try {
        var ver = getExternal() && getExternal().getVersion && getExternal().getVersion();
        if (ver) document.getElementById('versionDisplay').textContent = 'v' + ver;
      } catch (e) {}

      try {
        var stored = getExternal() && getExternal().readPlayerName && getExternal().readPlayerName();
        if (stored && playerName) playerName.value = stored;
      } catch (e) {}

      try {
        var storedOpts = getExternal() && getExternal().readLaunchOptions && getExternal().readLaunchOptions();
        if (storedOpts) {
          var parts = (storedOpts || '').split(' ').map(function(s){ return (s||'').trim().toLowerCase(); }).filter(Boolean);
          for (var i = 0; i < options.length; i++) {
            var opt = (options[i].getAttribute('data-option') || '').toLowerCase();
            if (opt && parts.indexOf(opt) !== -1) options[i].classList.add('active');
          }
        }
      } catch (e) {}

      var navBtns = document.querySelectorAll('.nav-btn');
      var pages = document.querySelectorAll('.page');

      function setPage(targetPage) {
        for (var j = 0; j < navBtns.length; j++) {
          navBtns[j].classList.remove('active');
          if (navBtns[j].getAttribute('data-page') === targetPage) navBtns[j].classList.add('active');
        }
        for (var k = 0; k < pages.length; k++) {
          pages[k].classList.remove('active');
        }
        document.getElementById(targetPage + 'Page').classList.add('active');
        var settingsBtn = document.getElementById('settingsBtn');
        if (settingsBtn) {
          if (targetPage === 'main') {
            settingsBtn.removeAttribute('data-hidden');
          } else {
            settingsBtn.setAttribute('data-hidden', '1');
            document.getElementById('settingsDropdown').classList.remove('open');
          }
        }
        
        if (targetPage === 'workshop' && workshopBrowseItems.length === 0 && !workshopBrowseLoading) {
          try {
            var ex = getExternal();
            if (ex && ex.workshopGetBrowseData) {
              var cachedData = ex.workshopGetBrowseData();
              if (cachedData && cachedData !== '[]') {
                var parsed = JSON.parse(cachedData);
                if (parsed && Array.isArray(parsed) && parsed.length > 0) {
                  workshopBrowseItems = parsed;
                  renderWorkshopBrowse();
                }
              }
            }
          } catch(e) {}
          
          if (workshopBrowseItems.length === 0) {
            var cached = loadWorkshopCache();
            if (cached && cached.length > 0) {
              workshopBrowseItems = cached;
              renderWorkshopBrowse();
            }
          }
          
          loadWorkshopBrowse(1, '');
        }
      }

      for (var i = 0; i < navBtns.length; i++) {
        (function(btn) {
          btn.onclick = function() {
            setPage(btn.getAttribute('data-page'));
          };
        })(navBtns[i]);
      }

      document.getElementById('settingsBtn').onclick = function(e) {
        e.stopPropagation();
        if (this.getAttribute('data-hidden')) return;
        document.getElementById('settingsDropdown').classList.toggle('open');
      };

      for (var i = 0; i < options.length; i++) {
        (function(opt) {
          opt.onclick = function(e) {
            e.stopPropagation();
            opt.classList.toggle('active');
          };
        })(options[i]);
      }

      document.addEventListener('click', function() {
        document.getElementById('settingsDropdown').classList.remove('open');
      });

      document.getElementById('playBtn').onclick = function() {
        var playBtn = document.getElementById('playBtn');
        try {
          var ex = getExternal();
          if (ex && ex.isGameRunning && ex.isGameRunning() === '1') {
            showMessage('Game Running', 'Black Ops III is already running.');
            return;
          }

          playBtn.disabled = true;
          playBtn.title = 'Launching...';

          var opts = getSelectedLaunchOption();
          var hasKeepLauncher = opts.toLowerCase().indexOf('keeplauncher') !== -1;

          if (window._workshopPollInterval && !hasKeepLauncher) {
            showConfirm('Download in progress', 'A workshop download is in progress. Keep the launcher open while you play?', function() {
              try {
                window.external.launchGame(getPlayerName(), opts);
              } catch (e2) {}
            });
            return;
          }

          if (hasKeepLauncher) {
            window.external.launchGame(getPlayerName(), opts);
            return;
          }

          window.external.runGame(getPlayerName(), opts);
        } catch (e) {}
      };

      setInterval(function() {
        var playBtn = document.getElementById('playBtn');
        if (!playBtn) return;
        try {
          var ex = getExternal();
          if (ex && ex.isGameRunning && ex.isGameRunning() === '1') {
            playBtn.disabled = true;
            playBtn.title = 'Game is already running';
          } else {
            playBtn.disabled = false;
            playBtn.title = '';
          }
        } catch (e) {}
      }, 1500);

      function showMessage(title, body) {
        var pop = document.getElementById('messagePopup');
        if (!pop) return;
        var t = document.getElementById('messagePopupTitle');
        var b = document.getElementById('messagePopupBody');
        if (t) t.textContent = title || 'Message';
        if (b) b.textContent = body || '';
        pop.classList.add('active');
      }

      function showConfirm(title, body, onConfirm) {
        var popup = document.getElementById('confirmPopup');
        if (!popup) return;
        var t = document.getElementById('confirmPopupTitle');
        var b = document.getElementById('confirmPopupBody');
        if (t) t.textContent = title || 'Confirm';
        if (b) b.textContent = body || '';
        popup.classList.add('active');
        var done = false;
        function close() {
          if (done) return;
          done = true;
          popup.classList.remove('active');
        }
        document.getElementById('confirmPopupCancel').onclick = function() { close(); };
        document.getElementById('confirmPopupConfirm').onclick = function() {
          close();
          if (typeof onConfirm === 'function') onConfirm();
        };
        var cClose = popup.querySelector('.popup-close');
        if (cClose) cClose.onclick = close;
        popup.onclick = function(e) { if (e.target === popup) close(); };
      }

      function hideMessagePopup() {
        var pop = document.getElementById('messagePopup');
        if (pop) pop.classList.remove('active');
      }
      document.getElementById('messagePopupOk').onclick = hideMessagePopup;
      document.getElementById('messagePopup').onclick = function(e) {
        if (e.target === document.getElementById('messagePopup')) hideMessagePopup();
      };
      var msgClose = document.querySelector('#messagePopup .popup-close');
      if (msgClose) msgClose.onclick = hideMessagePopup;

      document.getElementById('manageInstallBtn').onclick = function() {
        if (manageInstallPopup) { manageInstallPopup.classList.add('active'); }
        loadComponents();
      };

      function showProgress(message, percent, details) {
        var text = message || '';
        if (details) text += ' - ' + details;
        progressInfo.textContent = text;
        var pf = document.getElementById('progressFill');
        if (percent < 0) {
          if (pf && !pf.classList.contains('indeterminate')) pf.classList.add('indeterminate');
          progressPercent.textContent = '';
        } else {
          if (pf && pf.classList.contains('indeterminate')) { pf.classList.remove('indeterminate'); pf.style.transform = ''; }
          progressFill.style.width = percent + '%';
          progressPercent.textContent = percent > 0 ? (percent.toFixed(1) + '%') : '0%';
        }
        progressFooter.classList.add('active');
      }

      function hideProgress() {
        progressFooter.classList.remove('active');
      }

      function stopWorkshopDownloadCompletely() {
        try {
          var ex = getExternal();
          if (ex && ex.workshopCancelDownload) {
            ex.workshopCancelDownload();
          }
        } catch (e) {}
        if (window._workshopPollInterval) {
          clearInterval(window._workshopPollInterval);
          window._workshopPollInterval = null;
        }
        workshopDownloadBtn.disabled = false;
        workshopProgress.style.display = 'none';
        var msgEl = document.getElementById('workshopStatusMessage');
        if (msgEl) { msgEl.textContent = ''; msgEl.style.color = 'rgba(249,115,22,0.9)'; }
        var detEl = document.getElementById('workshopStatusDetails');
        if (detEl) detEl.textContent = '';
        var pctEl = document.getElementById('workshopProgressPercent');
        if (pctEl) pctEl.textContent = '';
        workshopProgressFill.style.width = '0%';
        workshopProgressFill.style.transform = '';
        workshopProgressFill.classList.remove('indeterminate');
        window._wsIndeterminate = false;
        hideProgress();
        setTimeout(refreshModsGrid, 300);
      }

      document.getElementById('progressCancel').onclick = function() {
        stopWorkshopDownloadCompletely();
      };

      progressOpenFolder.onclick = function() {
        if (_workshopDownloadFolder && _workshopDownloadFolder.length > 0) {
          try { window.external.openUrl(_workshopDownloadFolder); } catch (e) {}
        }
      };

      function hideManagePopup() {
        if (manageInstallPopup) manageInstallPopup.classList.remove('active');
      }
      manageInstallPopup.querySelector('.popup-close').onclick = hideManagePopup;
      document.getElementById('popupCancel').onclick = hideManagePopup;

      document.getElementById('popupApply').onclick = function() {
        var selected = [];
        var names = [];
        var prefixMap = { campaign: 'cp_', multiplayer: 'mp_', zombies: 'zm_' };
        var nameMap = { campaign: 'Campaign', multiplayer: 'Multiplayer', zombies: 'Zombies' };
        for (var key in componentSelection) {
          if (componentSelection[key] && modeFilesInfo[key] && modeFilesInfo[key].count > 0) {
            selected.push(prefixMap[key]);
            names.push(nameMap[key] + ' (' + modeFilesInfo[key].sizeHuman + ')');
          }
        }
        if (selected.length === 0) {
          showMessage('Delete', 'No game modes selected or selected modes have no files.');
          return;
        }
        hideManagePopup();
        showConfirm('Delete Game Modes', 'Are you sure you want to remove ' + names.join(', ') + '?\n\nThis cannot be undone.', function() {
          try {
            var ex = getExternal();
            if (ex && ex.removeModeFiles) {
              var result = ex.removeModeFiles(selected.join(','));
              var r = typeof result === 'string' ? JSON.parse(result) : result;
              var msg = 'Removed ' + r.removedCount + ' files (' + r.removedSize + ')';
              if (r.failedCount > 0) msg += '\nFailed to remove ' + r.failedCount + ' files';
              showMessage('Delete Complete', msg);
            }
          } catch (e) {
            showMessage('Error', 'Failed to remove files: ' + e.message);
          }
        });
      };

      manageInstallPopup.onclick = function(e) {
        if (e.target === manageInstallPopup) hideManagePopup();
      };

      (function() {
        var verifyPopup = document.getElementById('verifyPopup');
        var verifyStartBtn = document.getElementById('verifyStartBtn');
        var verifyCancelBtn = document.getElementById('verifyCancelBtn');
        var verifyProgressSection = document.getElementById('verifyProgressSection');
        var verifyStatusMsg = document.getElementById('verifyStatusMsg');
        var verifyProgressFill = document.getElementById('verifyProgressFill');
        var verifyProgressPct = document.getElementById('verifyProgressPct');
        var verifyStatusDetails = document.getElementById('verifyStatusDetails');
        var verifyResults = document.getElementById('verifyResults');
        var verifyCloseBtn = document.getElementById('verifyPopupClose');
        var verifyModeBtns = document.querySelectorAll('.verify-mode-btn');
        var selectedVerifyMode = 'all';
        var verifyPollInterval = null;
        var verifySeenRunning = false;
        var verifyMaxPct = 0;

        function resetVerifyUI() {
          verifyProgressSection.classList.remove('active');
          verifyResults.classList.remove('active');
          verifyResults.innerHTML = '';
          verifyStartBtn.style.display = '';
          verifyStartBtn.textContent = 'Start Verification';
          verifyCancelBtn.style.display = 'none';
          verifyProgressFill.style.width = '0%';
          verifyProgressPct.textContent = '0%';
          verifyStatusMsg.textContent = '';
          verifyStatusMsg.style.color = '';
          verifyStatusDetails.textContent = '';
          verifySeenRunning = false;
          verifyMaxPct = 0;
          for (var i = 0; i < verifyModeBtns.length; i++) verifyModeBtns[i].disabled = false;
        }

        function showVerifyPopup() {
          resetVerifyUI();
          verifyPopup.classList.add('active');
        }
        function hideVerifyPopup() {
          if (verifyPollInterval) { clearInterval(verifyPollInterval); verifyPollInterval = null; }
          verifyPopup.classList.remove('active');
          resetVerifyUI();
        }

        function showVerifyResults(changedFiles, message) {
          verifyResults.innerHTML = '';
          verifyResults.classList.add('active');
          if (!changedFiles || changedFiles.length === 0) {
            verifyResults.innerHTML = '<div class="verify-results-ok">' +
              '&#10004; All files verified â€” no changes detected.' +
              '</div>';
          } else {
            var html = '<div style="color:rgba(249,115,22,0.9);font-size:0.82rem;font-weight:600;margin-bottom:8px;">' +
              changedFiles.length + ' file' + (changedFiles.length > 1 ? 's' : '') + ' with issues:</div>';
            html += '<div class="verify-results-bad">';
            for (var i = 0; i < changedFiles.length; i++) {
              var raw = changedFiles[i];
              var isWarning = raw.indexOf('[warning]') === 0;
              var display = raw.replace(/^\[(warning|error)\]\s*/, '');
              var color = isWarning ? 'color:rgba(234,179,8,0.9)' : 'color:rgba(239,68,68,0.9)';
              html += '<div class="verify-file-item" style="' + color + '">' + escapeHtml(display) + '</div>';
            }
            html += '</div>';
            verifyResults.innerHTML = html;
          }
        }

        document.getElementById('verifyBtn').onclick = function() { showVerifyPopup(); };

        // ---- Set Game Path ----
        (function() {
          var pathDisplay = document.getElementById('currentPathDisplay');
          try {
            var ex = getExternal();
            if (ex && ex.getGamePath) {
              var p = ex.getGamePath();
              if (p) pathDisplay.textContent = p;
            }
          } catch(e) {}

          document.getElementById('setPathBtn').onclick = function() {
            try {
              var ex = getExternal();
              if (!ex || !ex.selectGameFolder) return;
              var result = ex.selectGameFolder();
              if (result === 'cancelled') return;
              if (result === 'invalid') {
                showMessage('Invalid Folder', 'The selected folder does not contain BlackOps3.exe.\\nPlease select a valid Black Ops 3 installation folder.');
                return;
              }
              if (result === 'error') {
                showMessage('Error', 'Failed to open folder picker.');
                return;
              }
              pathDisplay.textContent = result;
              showMessage('Game Path Updated', 'Game path set to:\\n' + result + '\\n\\nRestart BOIII for the change to take full effect.');
            } catch(e) {
              showMessage('Error', 'Failed to set game path: ' + e.message);
            }
          };
        })();

        verifyCloseBtn.onclick = function() {
          try { var ex = getExternal(); if (ex && ex.cancelVerify) ex.cancelVerify(); } catch(e) {}
          hideVerifyPopup();
        };
        verifyPopup.onclick = function(e) {
          if (e.target === verifyPopup) {
            try { var ex = getExternal(); if (ex && ex.cancelVerify) ex.cancelVerify(); } catch(e2) {}
            hideVerifyPopup();
          }
        };

        for (var i = 0; i < verifyModeBtns.length; i++) {
          (function(btn) {
            btn.onclick = function() {
              for (var j = 0; j < verifyModeBtns.length; j++) verifyModeBtns[j].classList.remove('selected');
              btn.classList.add('selected');
              selectedVerifyMode = btn.getAttribute('data-mode');
            };
          })(verifyModeBtns[i]);
        }

        verifyCancelBtn.onclick = function() {
          try { var ex = getExternal(); if (ex && ex.cancelVerify) ex.cancelVerify(); } catch(e) {}
          verifyCancelBtn.disabled = true;
        };

        function startVerify() {
          try {
            var ex = getExternal();
            if (!ex) { showMessage('Error', 'Verification not available.'); return; }
            var result = ex.verifyGameFiles(selectedVerifyMode);
            if (result === 'already_running') { showMessage('Verify', 'Verification is already running.'); return; }

            verifySeenRunning = false;
            verifyResults.classList.remove('active');
            verifyResults.innerHTML = '';
            verifyStartBtn.style.display = 'none';
            verifyCancelBtn.style.display = '';
            verifyCancelBtn.disabled = false;
            verifyProgressSection.classList.add('active');
            for (var k = 0; k < verifyModeBtns.length; k++) verifyModeBtns[k].disabled = true;

            verifyPollInterval = setInterval(function() {
              try {
                var ex2 = getExternal();
                if (!ex2 || !ex2.getVerifyStatus) return;
                var raw = ex2.getVerifyStatus();
                var st = typeof raw === 'string' ? JSON.parse(raw) : raw;

                if (st.running) verifySeenRunning = true;
                if (!st.running && st.progress >= 100) verifySeenRunning = true;
                if (!st.running && !verifySeenRunning && st.message && st.message.length > 0) {
                  clearInterval(verifyPollInterval);
                  verifyPollInterval = null;
                  verifyCancelBtn.style.display = 'none';
                  verifyStatusMsg.textContent = st.message;
                  verifyStatusMsg.style.color = '#ef4444';
                  verifyStartBtn.style.display = '';
                  verifyStartBtn.textContent = 'Close';
                  verifyStartBtn.onclick = function() { hideVerifyPopup(); verifyStartBtn.onclick = startVerify; verifyStartBtn.textContent = 'Start Verification'; };
                  for (var k = 0; k < verifyModeBtns.length; k++) verifyModeBtns[k].disabled = false;
                  return;
                }
                if (!verifySeenRunning) return;

                var rawPct = Math.min(st.progress || 0, 100);
                if (rawPct > verifyMaxPct) verifyMaxPct = rawPct;
                var pct = verifyMaxPct;
                verifyStatusMsg.textContent = st.message || '';
                if (st.message && (st.message.indexOf('missing') !== -1 || st.message.indexOf('wrong size') !== -1 || st.message.indexOf('Not installed') !== -1 || st.message.indexOf('No files found') !== -1)) {
                  verifyStatusMsg.style.color = '#ef4444';
                } else {
                  verifyStatusMsg.style.color = '';
                }
                verifyProgressFill.style.width = pct.toFixed(1) + '%';
                verifyProgressPct.textContent = pct.toFixed(1) + '%';
                verifyStatusDetails.textContent = st.details || '';

                if (!st.running && st.progress >= 100) {
                  clearInterval(verifyPollInterval);
                  verifyPollInterval = null;
                  verifyCancelBtn.style.display = 'none';
                  verifyProgressFill.style.width = '100%';
                  verifyProgressPct.textContent = '100%';

                  var isBaseline = st.message && st.message.indexOf('Baseline') !== -1;
                  if (isBaseline) {
                    verifyResults.classList.add('active');
                    verifyResults.innerHTML = '<div class="verify-results-ok">' +
                      '&#10004; ' + escapeHtml(st.message) + '</div>';
                  } else {
                    showVerifyResults(st.changedFiles || [], st.message);
                  }

                  for (var k = 0; k < verifyModeBtns.length; k++) verifyModeBtns[k].disabled = false;
                  verifyStartBtn.textContent = 'Verify Again';
                  verifyStartBtn.style.display = '';
                  verifyStartBtn.onclick = startVerify;
                } else if (!st.running && st.message && (st.message.indexOf('Cancelled') !== -1 || st.message.indexOf('No game files') !== -1)) {
                  clearInterval(verifyPollInterval);
                  verifyPollInterval = null;
                  verifyCancelBtn.style.display = 'none';
                  verifyStartBtn.style.display = '';
                  verifyStartBtn.textContent = 'Start Verification';
                  verifyStartBtn.onclick = startVerify;
                  for (var k = 0; k < verifyModeBtns.length; k++) verifyModeBtns[k].disabled = false;
                }
              } catch (e) {}
            }, 200);
          } catch (e) {
            showMessage('Error', 'Failed to start verification: ' + (e.message || ''));
          }
        }

        verifyStartBtn.onclick = startVerify;
      })();

      var componentSelection = { campaign: false, multiplayer: false, zombies: false };
      var modeFilesInfo = {};
      function loadComponents() {
        var list = document.getElementById('componentsList');
        list.innerHTML = '<div style="text-align:center;padding:20px;color:rgba(200,196,192,0.6);">Scanning files...</div>';
        componentSelection = { campaign: false, multiplayer: false, zombies: false };
        try {
          var ex = getExternal();
          if (ex && ex.getModeFilesInfo) {
            var raw = ex.getModeFilesInfo();
            modeFilesInfo = typeof raw === 'string' ? JSON.parse(raw) : raw;
          } else {
            modeFilesInfo = {};
          }
        } catch (e) {
          modeFilesInfo = {};
        }
        var items = [
          { id: 'campaign', name: 'Campaign', prefix: 'cp_' },
          { id: 'multiplayer', name: 'Multiplayer', prefix: 'mp_' },
          { id: 'zombies', name: 'Zombies', prefix: 'zm_' }
        ];
        list.innerHTML = '';
        for (var i = 0; i < items.length; i++) {
          var it = items[i];
          var info = modeFilesInfo[it.id] || { count: 0, size: 0, sizeHuman: '0 B' };
          var installed = info.count > 0;
          var sizeText = installed ? info.sizeHuman + ' (' + info.count + ' files)' : 'Not installed';
          var disabled = installed ? '' : ' disabled';
          var div = document.createElement('div');
          div.className = 'component-item';
          if (!installed) div.style.opacity = '0.5';
          div.innerHTML = '<div class="component-checkbox">' +
            '<input type="checkbox" id="comp-' + it.id + '" data-comp="' + it.id + '"' + disabled + '>' +
            '<span class="checkbox-visual"></span></div>' +
            '<div class="component-info"><div class="component-name">' + it.name + '</div>' +
            '<span class="component-size">' + sizeText + '</span></div>';
          list.appendChild(div);
          if (installed) {
            var cb = div.querySelector('input[type="checkbox"]');
            cb.onchange = function() {
              componentSelection[this.getAttribute('data-comp')] = this.checked;
            };
            div.onclick = function(e) {
              if (e.target.type !== 'checkbox') {
                var inp = this.querySelector('input[type="checkbox"]');
                if (inp && !inp.disabled) { inp.checked = !inp.checked; componentSelection[inp.getAttribute('data-comp')] = inp.checked; }
              }
            };
          }
        }
      }

      var _modsListPollInterval = null;
      var _removeProgressPollInterval = null;

      function startRemoveProgressPoll() {
        var bar = document.getElementById('removeProgressBar');
        var msg = document.getElementById('removeMsg');
        var det = document.getElementById('removeDetails');
        var fill = document.getElementById('removeFill');
        if (!bar) return;
        bar.style.display = 'block';
        if (msg) msg.textContent = 'Removing...';
        if (det) det.textContent = '';
        if (fill) { fill.style.width = '0%'; fill.classList.add('indeterminate'); }

        if (_removeProgressPollInterval) clearInterval(_removeProgressPollInterval);
        var pollCount = 0;
        _removeProgressPollInterval = setInterval(function() {
          pollCount++;
          if (pollCount > 600) {
            clearInterval(_removeProgressPollInterval);
            _removeProgressPollInterval = null;
            bar.style.display = 'none';
            refreshModsGrid();
            return;
          }
          try {
            var ex = getExternal();
            if (!ex || !ex.getRemoveStatus) return;
            var sj = ex.getRemoveStatus();
            if (!sj) return;
            var st = typeof sj === 'string' ? JSON.parse(sj) : sj;
            if (msg) msg.textContent = st.message || 'Removing...';
            if (det) det.textContent = st.details || '';
            if (fill) {
              if (st.progress >= 0 && st.progress <= 100) {
                fill.classList.remove('indeterminate');
                fill.style.transform = '';
                fill.style.width = Math.min(st.progress, 100) + '%';
              } else {
                fill.classList.add('indeterminate');
                fill.style.width = '';
              }
            }
            if (!st.running) {
              clearInterval(_removeProgressPollInterval);
              _removeProgressPollInterval = null;
              setTimeout(function() {
                bar.style.display = 'none';
                if (fill) { fill.classList.remove('indeterminate'); fill.style.width = '0%'; fill.style.transform = ''; }
                refreshModsGrid();
              }, 600);
            }
          } catch (e) {}
        }, 200);
      }

      function refreshModsGrid() {
        try {
          var ex = getExternal();
          if (!ex) {
            modsItemsCache = [];
            modsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#128230;</div><div class="empty-state-text">No workshop items installed yet</div></div>';
            if (modsPagination) modsPagination.style.display = 'none';
            return;
          }

          if (ex.workshopList) {
            var cached = ex.workshopList();
            if (cached && cached !== '[]') {
              var cachedItems = typeof cached === 'string' ? JSON.parse(cached) : cached;
              if (cachedItems && cachedItems.length > 0) {
                modsItemsCache = cachedItems;
                modsPage = 1;
                renderModsPage();
              } else {
                modsItemsCache = [];
                renderModsPage();
              }
            } else {
              modsItemsCache = [];
              renderModsPage();
            }
          }

          if (ex.workshopListAsync) {
            ex.workshopListAsync();
            if (_modsListPollInterval) clearInterval(_modsListPollInterval);
            var pollCount = 0;
            _modsListPollInterval = setInterval(function() {
              pollCount++;
              if (pollCount > 300) { 
                clearInterval(_modsListPollInterval);
                _modsListPollInterval = null;
                return;
              }
              try {
                var ex2 = getExternal();
                if (!ex2) return;
                var isLoading = ex2.workshopListIsLoading && ex2.workshopListIsLoading() === 'true';
                if (!isLoading) {
                  clearInterval(_modsListPollInterval);
                  _modsListPollInterval = null;
                  var list = ex2.workshopList();
                  if (list && list !== '[]') {
                    var items = typeof list === 'string' ? JSON.parse(list) : list;
                    if (items && items.length > 0) {
                      modsItemsCache = items;
                      modsPage = 1;
                      renderModsPage();
                    } else {
                      modsItemsCache = [];
                      renderModsPage();
                    }
                  } else {
                    modsItemsCache = [];
                    renderModsPage();
                  }
                }
              } catch (e) {}
            }, 100);
          }
        } catch (e) {
          modsItemsCache = [];
          modsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#9888;</div><div class="empty-state-text">Error loading workshop items</div></div>';
          if (modsPagination) modsPagination.style.display = 'none';
        }
      }

      function renderModsPage() {
        modsGrid.innerHTML = '';

        if (!modsItemsCache || modsItemsCache.length === 0) {
          modsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">&#128230;</div><div class="empty-state-text">No workshop items installed yet</div></div>';
          if (modsPagination) modsPagination.style.display = 'none';
          return;
        }

        var totalPages = Math.ceil(modsItemsCache.length / modsPageSize) || 1;
        if (modsPage < 1) modsPage = 1;
        if (modsPage > totalPages) modsPage = totalPages;

        var start = (modsPage - 1) * modsPageSize;
        var end = Math.min(start + modsPageSize, modsItemsCache.length);

        for (var i = start; i < end; i++) {
          var item = modsItemsCache[i];
          var card = document.createElement('div');
          card.className = 'mod-card';

          var header = document.createElement('div');
          header.className = 'mod-card-header';

          var nameDiv = document.createElement('div');
          nameDiv.className = 'mod-card-name';
          nameDiv.textContent = item.name || item.folder;
          nameDiv.title = item.name || item.folder;

          var typeDiv = document.createElement('div');
          typeDiv.className = 'mod-card-type';
          var typeText = (item.type || 'mod') + (item.source === 'steam' ? ' (Steam)' : '');
          if (item.needsUpdate) {
            typeDiv.innerHTML = typeText + ' <span style="color:#ff6600;font-weight:bold;margin-left:6px;">&#x21bb; Update available</span>';
          } else {
            typeDiv.textContent = typeText;
          }

          header.appendChild(nameDiv);
          header.appendChild(typeDiv);

          var descDiv = null;
          var descText = item.description || '';
          if (descText.length > 0) {
            descDiv = document.createElement('div');
            descDiv.className = 'mod-card-description';
            descDiv.textContent = descText;
            descDiv.title = descText.length > 120 ? descText.substring(0, 300) + '...' : descText;
          }

          var metaDiv = document.createElement('div');
          metaDiv.className = 'mod-card-meta';
          var hasMetaContent = false;

          var localSz = parseInt(item.localSize, 10) || 0;
          var apiSz = parseInt(item.file_size, 10) || 0;
          var sz = localSz > 0 ? localSz : apiSz;
          if (sz > 0) {
            var szStr = sz > 1073741824 ? (sz / 1073741824).toFixed(2) + ' GB' :
              sz > 1048576 ? (sz / 1048576).toFixed(1) + ' MB' :
              sz > 1024 ? (sz / 1024).toFixed(0) + ' KB' : sz + ' B';
            var sizeSpan = document.createElement('span');
            sizeSpan.title = localSz > 0 ? 'Size on disk' : 'Download size (Steam)';
            sizeSpan.innerHTML = '<span class="meta-icon">&#128190;</span> ' + szStr;
            metaDiv.appendChild(sizeSpan);
            hasMetaContent = true;
          }

          var sr = parseInt(item.starRating, 10) || 0;
          if (sr > 0) {
            var starStr = '';
            for (var s = 0; s < sr; s++) starStr += '\u2605';
            for (var s = sr; s < 5; s++) starStr += '\u2606';
            var rColor = sr >= 4 ? 'rgba(34,197,94,0.8)' : (sr >= 3 ? 'rgba(250,204,21,0.8)' : 'rgba(239,68,68,0.8)');
            var ratingSpan = document.createElement('span');
            ratingSpan.style.color = rColor;
            ratingSpan.title = sr + '/5 stars';
            ratingSpan.textContent = starStr;
            metaDiv.appendChild(ratingSpan);
            hasMetaContent = true;
          }

          var mSubs = parseInt(item.subs, 10) || 0;
          var mFavs = parseInt(item.favorites, 10) || 0;
          if (mSubs > 0) {
            var subsSpan = document.createElement('span');
            subsSpan.title = 'Subscribers';
            subsSpan.innerHTML = '<span class="meta-icon">&#128101;</span> ' + mSubs.toLocaleString();
            metaDiv.appendChild(subsSpan);
            hasMetaContent = true;
          }
          if (mFavs > 0) {
            var favsSpan = document.createElement('span');
            favsSpan.title = 'Favorites';
            favsSpan.innerHTML = '<span class="meta-icon">&#9829;</span> ' + mFavs.toLocaleString();
            metaDiv.appendChild(favsSpan);
            hasMetaContent = true;
          }

          var actions = document.createElement('div');
          actions.className = 'mod-card-actions';

          if (item.id && String(item.id).length > 0) {
            var viewBtn = document.createElement('button');
            viewBtn.className = 'btn';
            viewBtn.type = 'button';
            viewBtn.textContent = 'View';
            viewBtn.title = 'Open in Steam Workshop';
            viewBtn.setAttribute('data-open-url', 'https://steamcommunity.com/sharedfiles/filedetails/?id=' + String(item.id));
            actions.appendChild(viewBtn);
          }

          if (item.id && String(item.id).length > 0) {
            var updateBtn = document.createElement('button');
            updateBtn.className = 'btn';
            if (item.needsUpdate) {
              updateBtn.style.background = '#ff6600';
              updateBtn.style.color = '#fff';
              updateBtn.style.fontWeight = 'bold';
            }
            updateBtn.type = 'button';
            updateBtn.textContent = item.needsUpdate ? 'Update Now' : 'Update';
            updateBtn.title = item.needsUpdate ? 'A newer version is available on Steam Workshop' : 'Re-download from Steam Workshop';
            (function(itemId, itemName) {
              updateBtn.onclick = function(e) {
                e.stopPropagation();
                try {
                  var ex = getExternal();
                  if (ex && ex.workshopDownload) {
                    ex.workshopDownload(String(itemId));
                    workshopStatus.textContent = 'Updating ' + (itemName || itemId) + '...';
                    workshopProgress.style.display = 'block';
                    workshopProgressFill.style.width = '0%';
                    workshopDownloadBtn.disabled = true;
                    var pollInterval = setInterval(function() {
                      pollWorkshopStatus();
                      var ex2 = getExternal();
                      if (ex2 && ex2.workshopGetStatus) {
                        var sj = ex2.workshopGetStatus();
                        if (sj) {
                          var st = typeof sj === 'string' ? JSON.parse(sj) : sj;
                          if (st.message && (st.message.indexOf('Done') !== -1 || st.message.indexOf('Error') !== -1 || st.message.indexOf('Already installed') !== -1)) {
                            clearInterval(pollInterval);
                            workshopDownloadBtn.disabled = false;
                            setTimeout(refreshModsGrid, 500);
                          }
                        }
                      }
                    }, 500);
                  }
                } catch (err) {}
              };
            })(item.id, item.name || item.folder);
            actions.appendChild(updateBtn);
          }

          var removeBtn = document.createElement('button');
          removeBtn.className = 'btn btn-remove';
          removeBtn.type = 'button';
          removeBtn.textContent = 'Remove';
          removeBtn.title = 'Remove this mod from the mod list';
          (function(folderName, itemName, itemSource, itemPath) {
            removeBtn.onclick = function(e) {
              e.stopPropagation();
              if (!folderName && !itemPath) {
                showMessage('Remove', 'Cannot remove: folder name is missing.');
                return;
              }
              showConfirm('Remove workshop item', 'Remove "' + (itemName || folderName) + '" from your game folder?', function() {
                var ex = getExternal();
                if (!ex) {
                  showMessage('Remove', 'Workshop remove is not available.');
                  return;
                }
                var done = false;
                if (itemSource === 'steam' && itemPath) {
                  try { ex.workshopRemoveByPath(itemPath); done = true; } catch (e1) {}
                  if (!done) try { ex.invoke('workshopRemoveByPath', itemPath); done = true; } catch (e2) {}
                } else {
                  try { ex.workshopRemove(folderName); done = true; } catch (e1) {}
                  if (!done) try { ex.invoke('workshopRemove', folderName); done = true; } catch (e2) {}
                }
                if (done) {
                  startRemoveProgressPoll();
                } else {
                  showMessage('Remove', 'Workshop remove is not available.');
                }
              });
            };
          })(item.folder || '', item.name || item.folder, item.source || '', item.path || '');
          actions.appendChild(removeBtn);

          var body = document.createElement('div');
          body.className = 'mod-card-body';
          body.appendChild(header);
          if (descDiv) body.appendChild(descDiv);
          if (hasMetaContent) body.appendChild(metaDiv);
          body.appendChild(actions);

          if (item.image && String(item.image).length > 0) {
            var imgWrap = document.createElement('div');
            imgWrap.className = 'mod-card-image-wrap';
            var img = document.createElement('img');
            img.src = item.image;
            img.alt = '';
            img.onerror = function() { if (imgWrap && imgWrap.parentNode) imgWrap.parentNode.removeChild(imgWrap); };
            imgWrap.appendChild(img);
            card.appendChild(imgWrap);
          }
          card.appendChild(body);
          card.onclick = (function(folderPath) {
            return function(e) {
              if (folderPath) {
                window.external.openUrl(folderPath);
              }
            };
          })(item.path || '');
          modsGrid.appendChild(card);
        }

        if (modsPagination) {
          if (totalPages > 1) {
            modsPagination.style.display = 'flex';
            if (modsPageLabel) modsPageLabel.textContent = 'Page ' + modsPage + ' / ' + totalPages;
            if (modsPrevPageBtn) modsPrevPageBtn.disabled = modsPage <= 1;
            if (modsNextPageBtn) modsNextPageBtn.disabled = modsPage >= totalPages;
          } else {
            modsPagination.style.display = 'none';
          }
        }
      }

      refreshModsGrid();

      function pollWorkshopStatus() {
        try {
          var ex = getExternal();
          if (!ex || !ex.workshopGetStatus) return;
          var statusJson = ex.workshopGetStatus();
          if (!statusJson || statusJson.length === 0) return;
          var status = typeof statusJson === 'string' ? JSON.parse(statusJson) : statusJson;
          if (status.downloadFolder) _workshopDownloadFolder = status.downloadFolder;
          if (!window._lastWorkshopTerminalState) window._lastWorkshopTerminalState = '';

          var msgEl = document.getElementById('workshopStatusMessage');
          var detEl = document.getElementById('workshopStatusDetails');
          var pctEl = document.getElementById('workshopProgressPercent');

          if (status.message && status.message.length > 0) {
            workshopProgress.style.display = 'block';
            if (msgEl) msgEl.textContent = status.message;
            if (detEl) detEl.textContent = status.details || '';

            if (status.progress !== undefined && status.progress >= 0) {
              if (window._wsIndeterminate) {
                window._wsIndeterminate = false;
                workshopProgressFill.classList.remove('indeterminate');
                workshopProgressFill.style.transform = '';
                var pf2 = document.getElementById('progressFill');
                if (pf2) { pf2.classList.remove('indeterminate'); pf2.style.transform = ''; }
              }
              var p = Math.min(status.progress, 99);
              workshopProgressFill.style.width = p + '%';
              if (pctEl) pctEl.textContent = p > 0 ? (p.toFixed(1) + '%') : '';
              showProgress(status.message, p, status.details);
            } else if (status.progress !== undefined && status.progress < 0) {
              if (!window._wsIndeterminate) {
                window._wsIndeterminate = true;
                workshopProgressFill.classList.add('indeterminate');
                var pf3 = document.getElementById('progressFill');
                if (pf3) pf3.classList.add('indeterminate');
              }
              if (pctEl) pctEl.textContent = '';
              showProgress(status.message, -1, status.details);
            } else {
              workshopProgressFill.style.width = '0%';
              if (pctEl) pctEl.textContent = '';
              showProgress(status.message, 0, status.details);
            }

            var isDone = status.message.indexOf('Done') !== -1;
            var isError = status.message.indexOf('Error') !== -1;
            var isCanceled = status.message.indexOf('Canceled') !== -1;
            var isAlreadyInstalled = status.message.indexOf('Already installed') !== -1;
            if (isDone || isError || isCanceled || isAlreadyInstalled) {
              if (window._workshopPollInterval) {
                clearInterval(window._workshopPollInterval);
                window._workshopPollInterval = null;
              }
              workshopDownloadBtn.disabled = false;
              setTimeout(refreshModsGrid, 500);
              if (window._lastWorkshopTerminalState !== status.message) {
                window._lastWorkshopTerminalState = status.message;
                if (isDone) {
                  if (msgEl) msgEl.style.color = 'rgba(34,197,94,0.9)';
                  showMessage('Workshop', status.message + (status.details ? ('\n' + status.details) : ''));
                } else if (isCanceled) {
                  if (msgEl) msgEl.style.color = 'rgba(250,204,21,0.9)';
                } else {
                  if (msgEl) msgEl.style.color = 'rgba(239,68,68,0.9)';
                  showMessage('Workshop Error', status.message + (status.details ? ('\n' + status.details) : ''));
                }
              }

              if (isCanceled) {
                workshopProgress.style.display = 'none';
                if (msgEl) msgEl.style.color = 'rgba(249,115,22,0.9)';
                hideProgress();
              } else if (isAlreadyInstalled) {
                workshopProgress.style.display = 'none';
                if (msgEl) msgEl.style.color = 'rgba(249,115,22,0.9)';
                hideProgress();
                if (window._lastWorkshopTerminalState !== status.message) {
                  window._lastWorkshopTerminalState = status.message;
                  showMessage('Already Installed', status.details || 'This workshop item is already installed.\nRemove it first if you want to reinstall.');
                }
              } else if (isDone) {
                workshopId.value = '';
                setTimeout(function() {
                  workshopProgress.style.display = 'none';
                  if (msgEl) msgEl.style.color = 'rgba(249,115,22,0.9)';
                }, 4000);
                setTimeout(hideProgress, 4000);
              } else if (isError) {
                setTimeout(function() {
                  workshopProgress.style.display = 'none';
                  if (msgEl) msgEl.style.color = 'rgba(249,115,22,0.9)';
                }, 5000);
                setTimeout(hideProgress, 5000);
              }
            }
          }
        } catch (e) {}
      }

      var workshopProgressCancel = document.getElementById('workshopProgressCancel');
      if (workshopProgressCancel) {
        workshopProgressCancel.onclick = function() {
          stopWorkshopDownloadCompletely();
        };
      }

      modsGrid.onclick = function(e) {
        var t = e.target;
        while (t && t !== modsGrid) {
          var url = t.getAttribute && t.getAttribute('data-open-url');
          if (url) {
            e.preventDefault();
            e.stopPropagation();
            try { window.external.openUrl(url); } catch (err) {}
            return;
          }
          t = t.parentNode;
        }
      };

      if (modsPrevPageBtn) {
        modsPrevPageBtn.onclick = function() {
          if (modsPage > 1) {
            modsPage--;
            renderModsPage();
          }
        };
      }

      if (modsNextPageBtn) {
        modsNextPageBtn.onclick = function() {
          var totalPages = Math.ceil((modsItemsCache || []).length / modsPageSize) || 1;
          if (modsPage < totalPages) {
            modsPage++;
            renderModsPage();
          }
        };
      }

      document.getElementById('workshopRefreshBtn').onclick = function() {
        refreshModsGrid();
      };

      document.getElementById('deleteAllModsBtn').onclick = function() {
        showConfirm('Delete all mods', 'Remove ALL workshop mods and maps from your game folder? This cannot be undone.', function() {
          var ex = getExternal();
          if (!ex) return;
          var done = false;
          try { ex.workshopRemoveAll(); done = true; } catch (e1) {}
          if (!done) try { ex.invoke('workshopRemoveAll', ''); done = true; } catch (e2) {}
          if (done) startRemoveProgressPoll();
        });
      };

      document.getElementById('checkUpdatesBtn').onclick = function() {
        try {
          var ex = getExternal();
          if (!ex || !ex.workshopList) { workshopStatus.textContent = 'Cannot check updates.'; return; }

          workshopStatus.textContent = 'Checking for updates...';
          document.getElementById('checkUpdatesBtn').disabled = true;

          if (ex.workshopListAsync) {
            ex.workshopListAsync();
          }

          var checkPollCount = 0;
          var checkPoll = setInterval(function() {
            checkPollCount++;
            if (checkPollCount > 300) {
              clearInterval(checkPoll);
              workshopStatus.textContent = 'Update check timed out.';
              document.getElementById('checkUpdatesBtn').disabled = false;
              return;
            }
            try {
              var ex2 = getExternal();
              if (!ex2) return;
              var isLoading = ex2.workshopListIsLoading && ex2.workshopListIsLoading() === 'true';
              if (!isLoading) {
                clearInterval(checkPoll);
                var list = ex2.workshopList();
                if (!list || list.length === 0) { workshopStatus.textContent = 'No items installed.'; document.getElementById('checkUpdatesBtn').disabled = false; return; }
                var items = typeof list === 'string' ? JSON.parse(list) : list;

                modsItemsCache = items;
                modsPage = 1;
                renderModsPage();

                var toUpdate = [];
                for (var i = 0; i < items.length; i++) {
                  if (items[i].needsUpdate && items[i].id && String(items[i].id).length > 0) toUpdate.push(items[i]);
                }
                if (toUpdate.length === 0) {
                  workshopStatus.textContent = 'All items are up to date!';
                  document.getElementById('checkUpdatesBtn').disabled = false;
                  return;
                }
                workshopStatus.textContent = toUpdate.length + ' update(s) available. Downloading...';
                workshopProgress.style.display = 'block';
                workshopDownloadBtn.disabled = true;
                var idx = 0;
                function updateNext() {
                  if (idx >= toUpdate.length) {
                    workshopStatus.textContent = 'All updates complete.';
                    workshopDownloadBtn.disabled = false;
                    document.getElementById('checkUpdatesBtn').disabled = false;
                    setTimeout(refreshModsGrid, 500);
                    return;
                  }
                  var it = toUpdate[idx];
                  workshopStatus.textContent = 'Updating ' + (it.name || it.folder) + ' (' + (idx + 1) + '/' + toUpdate.length + ')...';
                  ex2.workshopDownload(String(it.id));
                  var pollInterval = setInterval(function() {
                    pollWorkshopStatus();
                    var ex3 = getExternal();
                    if (ex3 && ex3.workshopGetStatus) {
                      var sj = ex3.workshopGetStatus();
                      if (sj) {
                        var st = typeof sj === 'string' ? JSON.parse(sj) : sj;
                        if (st.message && (st.message.indexOf('Done') !== -1 || st.message.indexOf('Error') !== -1 || st.message.indexOf('Already installed') !== -1)) {
                          clearInterval(pollInterval);
                          idx++;
                          setTimeout(updateNext, 300);
                        }
                      }
                    }
                  }, 500);
                }
                updateNext();
              }
            } catch (e) {}
          }, 100);
        } catch (e) {
          workshopStatus.textContent = 'Error: ' + (e.message || 'failed');
          workshopDownloadBtn.disabled = false;
          document.getElementById('checkUpdatesBtn').disabled = false;
        }
      };

      workshopDownloadBtn.onclick = function() {
        var id = (workshopId && workshopId.value || '').trim();
        if (!id) {
          workshopStatus.textContent = 'Enter a Workshop ID or link.';
          return;
        }
        startWorkshopDownload(id, id);
      };
    })();
        </script>
</body>
</html>